<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>connectr+</title>
  <style>
    @font-face{
      font-family:'Garet';
      src: local('Garet');
      font-style:normal; font-weight:100 900; font-display:swap;
    }
    :root{
      --purple:#5E17EB;
      --neon:#C1FF72;
      --bg:#0A0A0B;         /* dark background */
      --fg:#F5F7FA;         /* light text */
      --muted:#A1A1AA;
      --card:#101114;       /* dark card */
      --line:#1b1c20;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:'Garet',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

    /* App shell */
    .app{display:grid;grid-template-rows:72px 1fr;min-height:100vh;max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;gap:12px;position:sticky;top:0;z-index:5;background:rgba(10,10,11,.7);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
    .logo{width:38px;height:38px;display:grid;place-items:center;border-radius:10px;background:var(--purple);color:white;position:relative}
    .logo::after{content:'+';position:absolute;right:-7px;top:-7px;width:18px;height:18px;border-radius:6px;display:grid;place-items:center;background:var(--neon);color:#101114;font-size:12px;font-weight:900}
    .brand-name{font-size:22px}

    .btn{appearance:none;border:1px solid var(--line);background:#15161a;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.purple{background:var(--purple);border-color:transparent}
    .btn.neon{background:var(--neon);color:#121212;border-color:transparent}
    .btn.ghost{background:transparent}

    main{display:grid;grid-template-rows:1fr 72px}

    .view{display:none;padding:24px}
    .view.active{display:block}

    /* Bottom nav */
    nav{position:sticky;bottom:0;left:0;right:0;border-top:1px solid var(--line);background:rgba(10,10,11,.8);backdrop-filter:blur(6px);height:72px;display:grid;grid-template-columns:repeat(5,1fr)}
    .nav-btn{position:relative;display:grid;place-items:center;color:#bcbcc2;font-size:12px;font-weight:700;gap:6px;cursor:pointer}
    .nav-btn svg{width:22px;height:22px;display:block;fill:currentColor}
    .nav-btn::before{content:"";position:absolute;inset:auto 18px 10px 18px;height:6px;border-radius:6px;background:transparent;transform:translateY(6px);transition:all .25s ease}
    .nav-btn.active{color:#ffffff}
    .nav-btn.active::before{background:var(--neon)}

    /* Layout helpers */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:12px;align-items:center}
    .row.spread{justify-content:space-between}
    .muted{color:var(--muted)}
    input[type=text],input[type=number],input[type=date],select,textarea{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#0f1013;color:var(--fg)}
    textarea{min-height:120px;resize:vertical}
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .seg .seg-btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#0f1013;color:var(--fg)}
    .seg .seg-btn.active{border-color:var(--purple);color:var(--neon);font-weight:800}

    /* Hero welcome (Celonis-like) */
    .hero{padding:40px 0}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#14151a;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--neon);font-weight:800}
    .headline{font-size:48px;line-height:1.02;margin:14px 0 6px 0;font-weight:900;letter-spacing:-.5px}
    .sub{color:#c7c7cf;max-width:70ch}

    /* Blackboard */
    .blackboard{background:#0c0d10;color:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);position:relative;overflow:hidden;border:1px solid #0b0b0b;background-image:radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));background-size:6px 6px,100% 100%}
    .blackboard h3{margin:0 0 8px 0}
    .blackboard .pin{position:absolute;right:18px;top:14px;background:var(--neon);color:#1a1a1a;font-weight:900;padding:2px 8px;border-radius:999px;font-size:12px}
    .board-notes{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:16px;margin-top:10px}
    .note{position:relative;background:#fff;color:#222;border-radius:12px;padding:14px 12px 12px 12px;min-height:110px;box-shadow:0 14px 28px rgba(0,0,0,.28),0 8px 12px rgba(0,0,0,.12);border:1px solid #e9e9ef;transform-origin:50% 12px}
    .note::before{content:"";position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:14px;height:14px;border-radius:50%;background:#e63946;box-shadow:0 1px 0 rgba(0,0,0,.25)}
    .note::after{content:"";position:absolute;top:-22px;left:calc(50% - 1px);width:2px;height:14px;background:linear-gradient(#999,#444);border-radius:1px}
    .note .meta{margin-top:8px;font-size:12px;color:#666}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:20}
    .modal .sheet{background:#111216;border:1px solid var(--line);border-radius:18px;width:min(780px,92vw);padding:18px;box-shadow:var(--shadow);color:var(--fg)}

    /* Messages */
    .list{display:flex;flex-direction:column;gap:12px}
    .list-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border:1px solid var(--line);border-radius:12px;background:#0f1013}
    .list-item.clickable{cursor:pointer}
    .avatar{width:40px;height:40px;border-radius:50%;background:#20222a;display:grid;place-items:center;font-weight:800;color:#e2e2e8}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;border:1px solid var(--line)}
    .bubble.me{background:var(--purple)}
    .bubble.them{background:#171821}

    /* Animations (scroll reveal) */
    .reveal{opacity:0;transform:translateY(18px);transition:opacity .6s ease, transform .6s ease}
    .reveal.in{opacity:1;transform:none}
    @media(min-width:880px){.headline{font-size:64px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">C</div>
        <div class="brand-name">connectr<span style="color:var(--neon)">+</span></div>
      </div>
      <div class="row">
        <button class="btn ghost" onclick="go('home')">Home</button>
        <button class="btn" onclick="go('search')">Search</button>
        <button class="btn purple" onclick="go('post')">New Listing</button>
      </div>
    </header>

    <main>
      <!-- HOME -->
      <section id="home" class="view active">
        <div class="hero reveal">
          <span class="pill">connectr+ marketplace</span>
          <div class="headline">Find it. Bid it. <span style="color:var(--neon)">Connect</span> it.</div>
          <p class="sub">A minimal, student‑friendly marketplace for buying, selling, swapping, and bidding on anything from textbooks to concert tickets. Fast. Local. Trust‑first.</p>
        </div>

        <div class="blackboard card reveal" style="grid-column:1/-1">
          <span class="pin">Announcements</span>
          <h3>Campus Blackboard</h3>
          <div id="blackboardList" class="board-notes"></div>
          <div class="row" style="margin-top:10px">
            <input id="blackboardText" type="text" placeholder="Share an announcement…"/>
            <button class="btn purple" onclick="addAnnouncement()">Pin to board</button>
          </div>
        </div>

        <div class="card reveal" style="grid-column:1/-1">
          <div class="row spread">
            <h3 style="margin:0">Trending listings</h3>
            <div class="muted">Buy now or place a bid</div>
          </div>
          <div id="trendingGrid" class="grid" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- SEARCH -->
      <section id="search" class="view">
        <div class="card reveal">
          <div class="row" style="gap:10px">
            <input id="searchInput" type="text" placeholder="Search by keyword…"/>
            <button class="btn purple" onclick="runSearch()">Search</button>
          </div>
        </div>
        <div id="searchResults" class="grid reveal" style="margin-top:16px"></div>
      </section>

      <!-- FAVOURITES -->
      <section id="favourites" class="view">
        <div class="row spread reveal" style="margin-bottom:12px">
          <h3 style="margin:0">Your favourites</h3>
          <button class="btn" onclick="clearFavourites()">Clear</button>
        </div>
        <div id="favGrid" class="grid reveal"></div>
      </section>

      <!-- POST -->
      <section id="post" class="view">
        <div class="card reveal">
          <h3 style="margin:0 0 10px 0">Create a listing</h3>
          <div class="seg" style="margin-bottom:10px">
            <div class="seg-btn active" data-val="offer" onclick="toggleSeg(this,'postType')">I offer</div>
            <div class="seg-btn" data-val="search" onclick="toggleSeg(this,'postType')">I am searching</div>
          </div>
          <div class="grid" style="grid-template-columns:1fr">
            <div class="row" style="align-items:flex-start; gap:16px; flex-wrap:wrap">
              <div style="flex:1 1 320px">
                <label class="muted">Title</label>
                <input id="p_title" type="text" placeholder="Give your listing a title (min. 10 chars)"/>
              </div>
              <div style="flex:1 1 220px">
                <label class="muted">Category</label>
                <input id="p_category" type="text" placeholder="Search category"/>
              </div>
            </div>
            <div>
              <label class="muted">Description</label>
              <textarea id="p_desc" placeholder="Describe the item…"></textarea>
            </div>
            <div class="row" style="gap:16px; flex-wrap:wrap">
              <div style="flex:1 1 160px">
                <label class="muted">Price</label>
                <input id="p_price" type="number" min="0" step="0.01" placeholder="0.00"/>
              </div>
              <div style="flex:1 1 220px">
                <label class="muted">Pricing type</label>
                <select id="p_pricetype" onchange="toggleAuction(this.value)">
                  <option value="fixed">Fixed price</option>
                  <option value="auction">Auction</option>
                  <option value="swap">Swap / Trade</option>
                </select>
              </div>
              <div style="flex:1 1 220px" id="auctionDueWrap" hidden>
                <label class="muted">Auction due date</label>
                <input id="p_due" type="date" />
              </div>
            </div>
            <div class="row" style="gap:10px; align-items:flex-start">
              <input id="p_images" type="file" multiple accept="image/*" onchange="previewImages(this.files)"/>
              <div id="p_preview" class="row" style="gap:8px; flex-wrap:wrap"></div>
            </div>
            <div class="row" style="gap:10px; margin-top:6px">
              <button class="btn neon" onclick="submitListing()">Publish listing</button>
            </div>
          </div>
        </div>
      </section>

      <!-- MESSAGES -->
      <section id="messages" class="view">
        <div class="row spread reveal" style="margin-bottom:10px">
          <h3 style="margin:0">Messages</h3>
          <div class="muted">Newest first</div>
        </div>
        <div id="msgList" class="list reveal"></div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="view">
        <div class="card reveal">
          <h3 style="margin:0 0 12px 0">Your profile</h3>
          <div class="row" style="gap:16px; align-items:flex-start; flex-wrap:wrap">
            <div class="row" style="gap:12px">
              <div class="avatar" id="avatar">U</div>
              <div>
                <input id="pf_name" type="text" placeholder="Your name"/>
                <div class="muted" style="margin-top:4px">Member since <span id="pf_since"></span></div>
              </div>
            </div>
          </div>
          <div class="row" style="gap:12px; margin-top:12px; flex-wrap:wrap">
            <input id="pf_location" type="text" placeholder="Location" style="flex:1 1 200px"/>
            <input id="pf_university" type="text" placeholder="University" style="flex:1 1 200px"/>
          </div>
          <div class="row" style="gap:10px; margin-top:12px">
            <button class="btn purple" onclick="saveProfile()">Save profile</button>
          </div>
        </div>
        <div class="grid reveal" style="margin-top:16px">
          <div class="card"><div class="row spread"><div class="muted">Listings online</div><div id="stat_listings">0</div></div></div>
          <div class="card"><div class="row spread"><div class="muted">Total favourites</div><div id="stat_favs">0</div></div></div>
          <div class="card"><div class="row spread"><div class="muted">Active auctions</div><div id="stat_auctions">0</div></div></div>
        </div>
      </section>

      <!-- Bottom nav -->
      <nav>
        <div class="nav-btn active" data-view="home" onclick="switchView(this)"><svg viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>Home</div>
        <div class="nav-btn" data-view="search" onclick="switchView(this)"><svg viewBox="0 0 24 24"><path d="M10 18a8 8 0 1 1 5.29-14.06L22 10.65l-1.41 1.41-3.7-3.7A8 8 0 0 1 10 18z"/></svg>Search</div>
        <div class="nav-btn" data-view="favourites" onclick="switchView(this)"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5A4.5 4.5 0 0 1 6.5 4c1.74 0 3.41.81 4.5 2.09A6 6 0 0 1 22 8.5c0 3.78-3.4 6.86-8.55 11.54z"/></svg>Favourites</div>
        <div class="nav-btn" data-view="messages" onclick="switchView(this)"><svg viewBox="0 0 24 24"><path d="M21 6h-18v12h4v4l6-4h8z"/></svg>Messages</div>
        <div class="nav-btn" data-view="profile" onclick="switchView(this)"><svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>Profile</div>
      </nav>
    </main>
  </div>

  <!-- Listing modal -->
  <div id="listingModal" class="modal" onclick="backdropClose(event)">
    <div class="sheet">
      <div class="row spread"><h3 id="lm_title" style="margin:0"></h3><button class="btn" onclick="closeModal('listingModal')">Close</button></div>
      <div id="lm_desc" class="muted" style="margin:8px 0 14px 0"></div>
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <button class="btn neon" id="lm_buy" onclick="buyNow()">Buy now</button>
        <div class="row" style="gap:8px">
          <input id="lm_bid_amt" type="number" min="0" step="0.01" placeholder="Your bid" style="width:140px"/>
          <button class="btn purple" onclick="placeBid()">Place bid</button>
        </div>
        <button class="btn" onclick="startChat()">Message seller</button>
      </div>
      <div id="lm_meta" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Chat modal -->
  <div id="chatModal" class="modal" onclick="backdropClose(event)">
    <div class="sheet">
      <div class="row spread"><h3 id="chatTitle" style="margin:0"></h3><button class="btn" onclick="closeModal('chatModal')">Close</button></div>
      <div id="chatThread" style="display:flex;flex-direction:column;gap:10px;margin:12px 0;max-height:45vh;overflow:auto"></div>
      <div class="row" style="gap:8px"><input id="chatInput" type="text" placeholder="Write a message…"/><button class="btn purple" onclick="sendChat()">Send</button></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const state = {
      listings: JSON.parse(localStorage.getItem('cx_listings')||'[]'),
      favourites: JSON.parse(localStorage.getItem('cx_favs')||'[]'),
      messages: JSON.parse(localStorage.getItem('cx_msgs')||'[]'), // [{id,peer,last,ts,thread:[{from:'me'|'them',text,ts}]}]
      blackboard: JSON.parse(localStorage.getItem('cx_board')||'[]'),
      profile: JSON.parse(localStorage.getItem('cx_profile')||'null') || { since: new Date().toISOString(), name: '', location:'', university:'', avatar:'' },
      selected: null,
      openChatId: null,
    };

    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));

    function persist(){
      localStorage.setItem('cx_listings', JSON.stringify(state.listings));
      localStorage.setItem('cx_favs', JSON.stringify(state.favourites));
      localStorage.setItem('cx_msgs', JSON.stringify(state.messages));
      localStorage.setItem('cx_board', JSON.stringify(state.blackboard));
      localStorage.setItem('cx_profile', JSON.stringify(state.profile));
      paint();
    }

    function go(view){
      // Directly switch to any view id (even if there is no nav button for it)
      showView(view);
    }"]`)[0];
      if(btn) switchView(btn);
    }

    function switchView(btn){
      els('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-view');
      showView(id);
    }
    function showView(id){
      els('.view').forEach(v=>v.classList.remove('active'));
      const target = el('#'+id);
      if(target){ target.classList.add('active'); }
      if(id==='favourites') renderFavourites();
      if(id==='messages') renderMessages();
      if(id==='profile') renderProfileStats();
      if(id==='home') renderHome();
      if(id==='search') runSearch();
      observeAll();
    }

    function paint(){ renderHome(); renderFavourites(); renderMessages(); renderProfileStats(); observeAll(); }

    /* ===== Hero + Blackboard ===== */
    function addAnnouncement(){
      const input = el('#blackboardText');
      const txt = input.value.trim();
      if(!txt) return;
      const angle = (Math.random()*8-4).toFixed(2);
      state.blackboard.unshift({ id: crypto.randomUUID(), text: txt, ts: Date.now(), angle });
      input.value='';
      persist();
    }
    function renderHome(){
      const board = el('#blackboardList');
      board.innerHTML = state.blackboard.map(a=>`<div class="note" style="transform:rotate(${a.angle||0}deg)"><div>${escapeHtml(a.text)}</div><div class="meta">${timeAgo(a.ts)}</div></div>`).join('') || '<div class="muted">No announcements yet.</div>';
      const trg = el('#trendingGrid');
      const items = state.listings.slice(0,8);
      trg.innerHTML = items.map(renderListingCard).join('') || `<div class="muted">No listings yet. Create one from <b>Post</b>.</div>`;
    }

    /* ===== Search ===== */
    function runSearch(){
      const q = (el('#searchInput')?.value||'').toLowerCase().trim();
      const res = !q ? state.listings : state.listings.filter(x=> x.title.toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q) || (x.desc||'').toLowerCase().includes(q));
      el('#searchResults').innerHTML = res.map(renderListingCard).join('') || '<div class="muted">No results.</div>';
    }

    /* ===== Favourites ===== */
    function toggleFav(id){ const i = state.favourites.indexOf(id); if(i>-1) state.favourites.splice(i,1); else state.favourites.push(id); persist(); }
    function isFav(id){ return state.favourites.includes(id) }
    function clearFavourites(){ state.favourites = []; persist(); }
    function renderFavourites(){ const favs = state.listings.filter(l=> state.favourites.includes(l.id)); el('#favGrid').innerHTML = favs.map(renderListingCard).join('') || '<div class="muted">Nothing here yet. Star some results from Search.</div>'; }

    /* ===== Post (create listing) ===== */
    function toggleSeg(elm){ elm.parentElement.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active')); elm.classList.add('active'); }
    function toggleAuction(val){ el('#auctionDueWrap').hidden = (val !== 'auction'); }
    function previewImages(files){ const p=el('#p_preview'); p.innerHTML=''; [...files].slice(0,5).forEach(f=>{ const img=document.createElement('img'); img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.style.borderRadius='8px'; img.src=URL.createObjectURL(f); p.appendChild(img);}); }
    function submitListing(){
      const title = el('#p_title').value.trim(); if(title.length<3){alert('Please add a title.');return}
      const listing = { id:crypto.randomUUID(), title, category:el('#p_category').value.trim(), desc:el('#p_desc').value.trim(), price:Number(el('#p_price').value||0), priceType:el('#p_pricetype').value, due: el('#p_due').value||null, seller: state.profile.name||'Seller', ts:Date.now() };
      state.listings.unshift(listing); persist(); alert('Listing published!'); go('search'); runSearch(); }

    /* ===== Messages & chat ===== */
    function renderMessages(){
      const list = el('#msgList');
      const rows = state.messages.sort((a,b)=>b.ts-a.ts).map(m=>`
        <div class="list-item clickable" onclick="openChat('${m.id}')">
          <div class="row" style="gap:10px">
            <div class="avatar">${(m.peer||'U').slice(0,1).toUpperCase()}</div>
            <div>
              <div><strong>${escapeHtml(m.peer)}</strong></div>
              <div class="muted">${escapeHtml(m.last)}</div>
            </div>
          </div>
          <div class="muted">${timeAgo(m.ts)}</div>
        </div>`).join('');
      list.innerHTML = rows || '<div class="muted">No messages yet.</div>';
    }
    function startChat(){ if(!state.selected) return; const id=crypto.randomUUID(); state.messages.unshift({ id, peer: state.selected.seller||'Seller', last:`Inquiry about ${state.selected.title}`, ts: Date.now(), thread:[{from:'me',text:`Hi! Is "${state.selected.title}" available?`, ts:Date.now()}]}); persist(); closeModal('listingModal'); openChat(id); }
    function openChat(id){ const m=state.messages.find(x=>x.id===id); if(!m) return; state.openChatId=id; el('#chatTitle').textContent=m.peer; const box=el('#chatThread'); box.innerHTML=m.thread.map(t=>`<div style="display:flex; ${t.from==='me'?'justify-content:flex-end':''}"><div class="bubble ${t.from==='me'?'me':'them'}">${escapeHtml(t.text)}</div></div>`).join(''); openModal('chatModal'); box.scrollTop=box.scrollHeight; }
    function sendChat(){ const msg=el('#chatInput').value.trim(); if(!msg) return; const m=state.messages.find(x=>x.id===state.openChatId); m.thread.push({from:'me', text:msg, ts:Date.now()}); m.last=msg; m.ts=Date.now(); el('#chatInput').value=''; persist(); openChat(m.id); }

    /* ===== Listing card & modal ===== */
    function renderListingCard(l){
      const fav=isFav(l.id);
      const priceStr = l.priceType==='auction' ? `Current bid: $${(l.price||0).toFixed(2)}` : (l.priceType==='swap' ? 'Swap / Trade' : `$${(l.price||0).toFixed(2)}`);
      const badge = l.priceType==='auction'?`<span class="muted">Auction${l.due?` · ends ${l.due}`:''}</span>`: l.priceType==='swap'?`<span class="muted">Swap</span>`:`<span class="muted">Fixed</span>`;
      return `<div class="card reveal">
        <div class="row spread">
          <div style="font-weight:800">${escapeHtml(l.title)}</div>
          <button class="seg-btn ${fav?'active':''}" onclick="toggleFav('${l.id}')">${fav?'★':'☆'}</button>
        </div>
        <div class="muted">${escapeHtml(l.category||'Misc')}</div>
        <div class="row spread" style="margin-top:4px">
          <div style="font-size:18px; font-weight:800">${priceStr}</div>
          ${badge}
        </div>
        <div class="row" style="gap:8px">
          <button class="btn neon" onclick='openListing(${JSON.stringify(l.id)})'>View</button>
        </div>
      </div>`;
    }
    function openListing(id){ const l=state.listings.find(x=>x.id===id); state.selected=l; el('#lm_title').textContent=l.title; el('#lm_desc').textContent=l.desc||'—'; el('#lm_meta').textContent=`${l.priceType.toUpperCase()} • Seller: ${l.seller||'Seller'} • Posted ${timeAgo(l.ts)}`; el('#lm_bid_amt').value = l.price ? (l.price + 1).toFixed(2) : ''; openModal('listingModal'); }
    function buyNow(){ if(!state.selected) return; alert(`Buy-now initiated for "${state.selected.title}" at $${(state.selected.price||0).toFixed(2)} (prototype).`); closeModal('listingModal'); }
    function placeBid(){ if(!state.selected) return; const amt=Number(el('#lm_bid_amt').value||0); if(amt<=0){alert('Enter a valid bid');return} state.selected.price=Math.max(state.selected.price||0,amt); persist(); alert('Bid placed (prototype).'); closeModal('listingModal'); }

    /* ===== Profile ===== */
    function renderProfileStats(){ el('#pf_since').textContent=new Date(state.profile.since).toLocaleDateString(); el('#pf_name').value=state.profile.name||''; el('#pf_location').value=state.profile.location||''; el('#pf_university').value=state.profile.university||''; el('#stat_listings').textContent=state.listings.length; el('#stat_favs').textContent=state.favourites.length; el('#stat_auctions').textContent=state.listings.filter(l=>l.priceType==='auction').length; el('#avatar').textContent=(state.profile.name||'U').slice(0,1).toUpperCase(); }
    function saveProfile(){ state.profile.name=el('#pf_name').value.trim(); state.profile.location=el('#pf_location').value.trim(); state.profile.university=el('#pf_university').value.trim(); persist(); alert('Profile saved.'); }

    /* ===== Modal + reveal helpers ===== */
    function openModal(id){ el('#'+id).style.display='flex'; }
    function closeModal(id){ el('#'+id).style.display='none'; }
    function backdropClose(e){ if(e.target.classList.contains('modal')) e.target.style.display='none'; }

    function timeAgo(ts){ const s=Math.floor((Date.now()-ts)/1000); if(s<60) return `${s}s ago`; const m=Math.floor(s/60); if(m<60) return `${m}m ago`; const h=Math.floor(m/60); if(h<24) return `${h}h ago`; const d=Math.floor(h/24); return `${d}d ago`; }
    function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    function observeAll(){ const io=new IntersectionObserver(es=>es.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('in'); }),{threshold:.12}); els('.reveal').forEach(n=>io.observe(n)); }

    /* Seed demo data */
    if(state.listings.length===0){ state.listings=[ {id:crypto.randomUUID(), title:'Concert Ticket – Front Row', category:'Events', desc:'One ticket, tomorrow night.', price:85, priceType:'auction', due:new Date(Date.now()+86400000).toISOString().slice(0,10), seller:'Alex', ts: Date.now()-3600_000}, {id:crypto.randomUUID(), title:'Textbook: Microeconomics', category:'Books', desc:'Lightly used, highlights in Chapter 3.', price:25, priceType:'fixed', seller:'Sam', ts: Date.now()-7200_000}, {id:crypto.randomUUID(), title:'Swap: Calculus notes for Stats notes', category:'Swap', desc:'Great summaries.', price:0, priceType:'swap', seller:'Riley', ts: Date.now()-17200_000} ]; }
    if(state.messages.length===0){ state.messages=[ {id:crypto.randomUUID(), peer:'Alex', last:'Tickets still available?', ts:Date.now()-200000, thread:[{from:'them',text:'Hey! Are you interested in the ticket?',ts:Date.now()-300000}] } ]; }

    paint();
  </script>
</body>
</html>

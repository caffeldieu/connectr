<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>connectr+</title>
  <style>
    @font-face{
      font-family:'Garet';
      src: local('Garet');
      font-style:normal; font-weight:100 900; font-display:swap;
    }
    :root{
      --purple:#5E17EB;
      --neon:#C1FF72;
      --bg:#0A0A0B;
      --fg:#F5F7FA;
      --muted:#A1A1AA;
      --card:#101114;
      --line:#1b1c20;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,0.35);
      --danger:#ff4d6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(ellipse at top, #1a1b2f, #050509);
      color:var(--fg);
      font-family:'Garet',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      display:flex;
      flex-direction:column;
    }
    a{color:inherit;text-decoration:none}
    button{
      font-family:inherit;
      cursor:pointer;
    }
    .page{
      max-width:1040px;
      margin:0 auto;
      padding:20px 16px 40px;
      width:100%;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-badge{
      width:34px;
      height:34px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--purple),#9B5BFF);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:18px;
      color:white;
      box-shadow:0 6px 18px rgba(0,0,0,0.4);
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title span:first-child{
      font-weight:700;
      letter-spacing:0.06em;
      text-transform:uppercase;
      font-size:13px;
    }
    .brand-title span:last-child{
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(193,255,114,0.11);
      color:var(--neon);
      font-size:11px;
    }
    .pill-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--neon);
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .btn{
      border-radius:999px;
      padding:8px 14px;
      border:1px solid transparent;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#15151b;
      color:var(--fg);
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--purple),#9B5BFF);
      border-color:#7a3cff;
      color:white;
      box-shadow:var(--shadow);
    }
    .btn-outline{
      border-color:var(--line);
      background:rgba(15,16,19,0.9);
    }
    .btn-danger{
      border-color:var(--danger);
      color:var(--danger);
      background:rgba(255,77,106,0.06);
    }
    main{
      display:grid;
      grid-template-columns: minmax(0, 5fr) minmax(0, 4fr);
      gap:20px;
    }
    @media(max-width:880px){
      main{grid-template-columns:1fr; }
    }
    .card{
      background:radial-gradient(circle at top left,#181927,#101114 55%);
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.02);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top,var(--purple) 0,transparent 60%);
      opacity:0.08;
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1;}
    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .card-title{
      font-size:16px;
      font-weight:600;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .badge{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      color:var(--muted);
    }
    .section{
      margin-top:10px;
      border-top:1px solid rgba(255,255,255,0.06);
      padding-top:12px;
    }

    /* Forms */
    form{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:2px;
      display:block;
    }
    input[type=text],
    input[type=email],
    input[type=password],
    input[type=number],
    input[type=date],
    input[type=file],
    select,
    textarea{
      width:100%;
      padding:11px 13px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#0f1013;
      color:var(--fg);
      font-family:inherit;
      font-size:13px;
    }
    input[type=file]{
      padding:8px;
      cursor:pointer;
    }
    textarea{
      min-height:80px;
      resize:vertical;
    }
    .helper{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .field-row{
      display:flex;
      gap:10px;
    }
    .field-row > div{flex:1;}

    .error-banner{
      background:rgba(255,77,106,0.09);
      border:1px solid rgba(255,77,106,0.6);
      color:#ffb3c1;
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      margin-bottom:8px;
      display:none;
    }

    .chip-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .chip{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      color:var(--muted);
      cursor:pointer;
    }
    .chip.active{
      border-color:var(--neon);
      color:var(--neon);
      background:rgba(193,255,114,0.08);
    }

    /* Listings grid */
    .listings-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:12px;
    }
    .listings-header h3{
      margin:0;
      font-size:14px;
    }
    .listings-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .listing-card{
      background:#111218;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.04);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .listing-thumb{
      width:100%;
      aspect-ratio:4/3;
      border-radius:12px;
      background:#181a20;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:var(--muted);
    }
    .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .listing-title{
      font-size:13px;
      font-weight:500;
    }
    .listing-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
    }
    .price{
      font-weight:600;
      color:var(--neon);
    }
    .empty-state{
      font-size:12px;
      color:var(--muted);
      padding:8px 0;
    }

    .pill-user{
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      background:#14151c;
      border:1px solid rgba(255,255,255,0.07);
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="logo-badge">c+</div>
        <div class="brand-title">
          <span>connectr+</span>
          <span>Student-only campus marketplace</span>
        </div>
      </div>
      <div class="top-actions">
        <div id="user-pill" class="pill-user" style="display:none;"></div>
        <button id="logout-btn" class="btn btn-outline" style="display:none;">Log out</button>
        <button id="login-open-btn" class="btn btn-primary">Log in</button>
      </div>
    </header>

    <main>
      <!-- LEFT: Auth + Create Listing -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="pill">
                <span class="pill-dot"></span>
                <span>Private beta · IE University</span>
              </div>
              <div class="card-title" style="margin-top:8px;">Sign in & publish a listing</div>
              <div class="card-sub">
                Log in with your email, then add an item with photos, price, and category.
              </div>
            </div>
            <span class="badge">For students only</span>
          </div>

          <!-- Auth section -->
          <div class="section" id="auth-section">
            <div id="auth-error" class="error-banner"></div>
            <form id="login-form">
              <div>
                <label for="login-email">Email</label>
                <input id="login-email" type="email" placeholder="you@student.ie.edu" required />
              </div>
              <div>
                <label for="login-password">Password</label>
                <input id="login-password" type="password" placeholder="••••••••" required />
              </div>
              <button type="submit" class="btn btn-primary" style="margin-top:4px;width:100%;justify-content:center;">
                Log in
              </button>
              <div class="helper">
                We use a demo auth service for this project – no real IE credentials.
              </div>
            </form>
          </div>

          <!-- Create listing section (visible only when logged in) -->
          <div class="section" id="create-listing-section" style="display:none;">
            <div id="listing-error" class="error-banner"></div>
            <form id="create-listing-form">
              <div>
                <label for="listing-title-input">Title</label>
                <input id="listing-title-input" type="text" placeholder="Vintage Econ textbook, 2nd edition" required />
              </div>

              <div>
                <label for="listing-description-input">Description</label>
                <textarea id="listing-description-input" placeholder="Condition, pickup info, bundle offers…"></textarea>
              </div>

              <div class="field-row">
                <div>
                  <label for="listing-category-input">Category</label>
                  <select id="listing-category-input">
                    <option value="books">Books</option>
                    <option value="electronics">Electronics</option>
                    <option value="furniture">Furniture</option>
                    <option value="tickets">Tickets & events</option>
                    <option value="clothing">Clothing</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label for="listing-price-input">Price (€)</label>
                  <input id="listing-price-input" type="number" min="0" step="0.5" placeholder="15" />
                </div>
              </div>

              <div>
                <label for="listing-photo-input">Photo (optional)</label>
                <input id="listing-photo-input" type="file" accept="image/*" />
                <div class="helper">
                  JPG or PNG. First photo becomes the main thumbnail.
                </div>
              </div>

              <button type="submit" class="btn btn-primary" style="margin-top:6px;width:100%;justify-content:center;">
                Publish listing
              </button>
            </form>
          </div>
        </div>
      </section>

      <!-- RIGHT: Listings preview -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Your campus marketplace</div>
              <div class="card-sub">
                Recent listings on connectr+. Once you publish, your item appears here.
              </div>
            </div>
            <span class="badge" id="listing-count-badge">0 active listings</span>
          </div>

          <div class="section">
            <div class="listings-header">
              <h3>Latest listings</h3>
              <button id="refresh-listings-btn" class="btn btn-outline" style="font-size:11px;padding:5px 9px;">
                Refresh
              </button>
            </div>
            <div id="listings-container">
              <div class="empty-state">
                No listings yet. Be the first to post something for your campus ✨
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // === API endpoints ===
    const API_AUTH_LOGIN = "https://users-svc.bluecoast-b88fe4f5.northeurope.azurecontainerapps.io/auth/login";
    const API_AUTH_ME   = "https://users-svc.bluecoast-b88fe4f5.northeurope.azurecontainerapps.io/auth/me";
    const API_LISTINGS  = "https://listings-svc.bluecoast-b88fe4f5.northeurope.azurecontainerapps.io/listings";

    // === Simple global state ===
    const state = {
      token: null,
      user: null,
      listings: []
    };

    const loginForm            = document.getElementById('login-form');
    const authErrorBox         = document.getElementById('auth-error');
    const listingErrorBox      = document.getElementById('listing-error');
    const authSection          = document.getElementById('auth-section');
    const createListingSection = document.getElementById('create-listing-section');
    const userPill             = document.getElementById('user-pill');
    const logoutBtn            = document.getElementById('logout-btn');
    const loginOpenBtn         = document.getElementById('login-open-btn');
    const listingsContainer    = document.getElementById('listings-container');
    const listingCountBadge    = document.getElementById('listing-count-badge');
    const refreshListingsBtn   = document.getElementById('refresh-listings-btn');
    const createListingForm    = document.getElementById('create-listing-form');

    // === UI helpers ===
    function setAuthError(msg){
      if(!msg){
        authErrorBox.style.display = 'none';
        authErrorBox.textContent = '';
      } else {
        authErrorBox.style.display = 'block';
        authErrorBox.textContent = msg;
      }
    }
    function setListingError(msg){
      if(!msg){
        listingErrorBox.style.display = 'none';
        listingErrorBox.textContent = '';
      } else {
        listingErrorBox.style.display = 'block';
        listingErrorBox.textContent = msg;
      }
    }

    function updateAuthUI(){
      if(state.user && state.token){
        authSection.style.display = 'none';
        createListingSection.style.display = 'block';
        userPill.style.display = 'inline-flex';
        logoutBtn.style.display = 'inline-flex';
        loginOpenBtn.style.display = 'none';
        userPill.textContent = state.user.display_name + " · " + state.user.email;
      }else{
        authSection.style.display = 'block';
        createListingSection.style.display = 'none';
        userPill.style.display = 'none';
        logoutBtn.style.display = 'none';
        loginOpenBtn.style.display = 'inline-flex';
        userPill.textContent = '';
      }
    }

    // === Auth logic ===
    async function fetchMe(){
      if(!state.token) return;
      try{
        const res = await fetch(API_AUTH_ME,{
          headers:{ Authorization: `Bearer ${state.token}` }
        });
        if(!res.ok){
          throw new Error("Failed to fetch current user");
        }
        const data = await res.json();
        state.user = data;
        updateAuthUI();
      }catch(err){
        console.error(err);
        state.user = null;
        state.token = null;
        updateAuthUI();
      }
    }

    async function handleLogin(e){
      e.preventDefault();
      setAuthError('');
      const email    = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if(!email || !password){
        setAuthError("Please enter both email and password.");
        return;
      }

      try{
        const res = await fetch(API_AUTH_LOGIN,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ email, password })
        });

        const rawText = await res.text();
        if(!res.ok){
          throw new Error(rawText || "Login failed");
        }

        const data = JSON.parse(rawText);
        // backend returns { access_token, token_type } or { token }
        state.token = data.access_token || data.token || null;

        if(!state.token){
          throw new Error("Missing token in login response");
        }

        await fetchMe();
        setAuthError('');
      }catch(err){
        console.error(err);
        setAuthError(err.message || "Login failed");
      }
    }

    function handleLogout(){
      state.token = null;
      state.user  = null;
      updateAuthUI();
    }

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    loginOpenBtn.addEventListener('click', ()=>{
      authSection.scrollIntoView({behavior:'smooth',block:'start'});
    });

    // === Create listing with photo ===
    async function handleCreateListing(e){
      e.preventDefault();
      setListingError('');

      if(!state.token || !state.user){
        setListingError("Please log in first.");
        return;
      }

      const title       = document.getElementById('listing-title-input').value.trim();
      const description = document.getElementById('listing-description-input').value.trim();
      const category    = document.getElementById('listing-category-input').value;
      const price       = document.getElementById('listing-price-input').value || "0";
      const visibility  = "public";
      const fileInput   = document.getElementById('listing-photo-input');

      if(!title){
        setListingError("Title is required.");
        return;
      }

      try{
        const formData = new FormData();
        formData.append("title", title);
        formData.append("description", description);
        formData.append("category", category);
        formData.append("price", price);
        formData.append("visibility", visibility);

        if(fileInput.files && fileInput.files[0]){
          formData.append("photo", fileInput.files[0]);
        }

        const res = await fetch(API_LISTINGS,{
          method:"POST",
          headers:{
            Authorization: `Bearer ${state.token}`
            // DO NOT set Content-Type with FormData
          },
          body: formData
        });

        const raw = await res.text();
        if(!res.ok){
          throw new Error(raw || "Failed to create listing");
        }

        const data = JSON.parse(raw);
        console.log("Listing created:", data);

        // optimistic UI: prepend to listings
        state.listings.unshift(data);
        renderListings();

        // clear form
        createListingForm.reset();
        setListingError('');
      }catch(err){
        console.error(err);
        setListingError(err.message || "Failed to create listing");
      }
    }

    createListingForm.addEventListener('submit', handleCreateListing);

    // === Fetch & render listings (basic GET implementation) ===
    async function fetchListings(){
      try{
        const res = await fetch(API_LISTINGS);
        const data = await res.json();
        if(Array.isArray(data)){
          state.listings = data;
        }else if(Array.isArray(data.items)){
          state.listings = data.items;
        }else{
          state.listings = [];
        }
        renderListings();
      }catch(err){
        console.error("Failed to fetch listings", err);
      }
    }

    function renderListings(){
      const list = state.listings;
      if(!list || list.length === 0){
        listingsContainer.innerHTML = '<div class="empty-state">No listings yet. Be the first to post something for your campus ✨</div>';
        listingCountBadge.textContent = "0 active listings";
        return;
      }

      listingCountBadge.textContent = `${list.length} active listing${list.length === 1 ? "" : "s"}`;

      const html = [
        '<div class="listings-grid">',
        ...list.map(item => {
          const price   = typeof item.price === 'number' ? item.price : parseFloat(item.price || '0');
          const imgUrl  = item.imageUrl || item.photoUrl || item.image || "";
          const safeCat = (item.category || '').toString();
          const seller  = (item.sellerName || item.sellerEmail || '').toString();

          return `
            <article class="listing-card">
              <div class="listing-thumb">
                ${
                  imgUrl
                    ? `<img src="${imgUrl}" alt="${item.title || "Listing photo"}">`
                    : `<span>No photo</span>`
                }
              </div>
              <div class="listing-title">${item.title || "Untitled listing"}</div>
              <div class="listing-meta">
                <span>${safeCat}</span>
                <span class="price">${price ? price.toFixed(2) + " €" : "Free"}</span>
              </div>
              <div class="listing-meta" style="font-size:10px;">
                <span>${seller}</span>
                <span>${(item.status || "active")}</span>
              </div>
            </article>
          `;
        }),
        '</div>'
      ].join('');

      listingsContainer.innerHTML = html;
    }

    refreshListingsBtn.addEventListener('click', fetchListings);

    // === Init ===
    updateAuthUI();
    fetchListings();
  </script>
</body>
</html>

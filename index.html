<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>connectr+</title>
  <style>
    @font-face{
      font-family:'Garet';
      src: local('Garet');
      font-style:normal; font-weight:100 900; font-display:swap;
    }
    :root{
      --purple:#5E17EB;
      --neon:#C1FF72;
      --bg:#0A0A0B;
      --fg:#F5F7FA;
      --muted:#A1A1AA;
      --card:#101114;
      --line:#1b1c20;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,0.35);
      --danger:#ff4d6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(ellipse at top, #1a1b2e 0%, #0a0a0f 40%, #050506 70%);
      color:var(--fg);
      font-family:'Garet',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    a{color:inherit;text-decoration:none}
    .app{
      display:grid;
      grid-template-rows:72px 1fr;
      min-height:100vh;
      max-width:1200px;
      margin:0 auto;
      padding:0 12px 0 12px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 8px;
      gap:16px;
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(5,5,8,.88);
      backdrop-filter:blur(12px);
      border-bottom:1px solid var(--line);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo{
      width:38px;
      height:38px;
      display:grid;
      place-items:center;
      border-radius:10px;
      background:radial-gradient(circle at 20% 0, #c1ff72, #5e17eb);
      color:white;
      position:relative;
      box-shadow:0 0 18px rgba(193,255,114,.55);
    }
    .logo::after{
      content:'+';
      position:absolute;
      right:-7px;
      top:-7px;
      width:18px;
      height:18px;
      border-radius:6px;
      display:grid;
      place-items:center;
      background:var(--neon);
      color:#101114;
      font-size:12px;
      font-weight:900;
      box-shadow:0 0 12px rgba(193,255,114,.7);
    }
    .brand-name{font-size:22px}
    .brand-tag{font-size:11px;color:var(--muted);margin-top:2px}
    .header-center{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .header-auth{
      display:flex;
      gap:8px;
      align-items:center;
    }
    button{
      font-family:inherit;
      cursor:pointer;
      border:none;
      background:none;
      color:inherit;
    }
    .btn{
      padding:9px 14px;
      border-radius:8px;
      font-weight:600;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:all .2s;
    }
    .btn.purple{
      background:var(--purple);
      color:white;
    }
    .btn.purple:hover{
      background:#7429ff;
    }
    .btn.neon{
      background:var(--neon);
      color:#101114;
    }
    .btn.neon:hover{
      background:#d8ff8f;
    }
    .btn.ghost{
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
    }
    .btn.ghost:hover{
      background:rgba(255,255,255,.04);
      color:var(--fg);
    }
    .btn.small{
      padding:7px 12px;
      font-size:12px;
    }
    .btn.danger{
      background:var(--danger);
      color:white;
    }
    .btn.danger:hover{
      background:#ff6680;
    }
    .btn:disabled{
      opacity:.4;
      cursor:not-allowed;
    }
    .btn.icon-only{
      width:36px;
      height:36px;
      display:grid;
      place-items:center;
      border-radius:999px;
      font-size:16px;
    }
    .seg-btn{
      border:1px solid var(--line);
      background:#141518;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      cursor:pointer;
      transition:all .2s;
    }
    .seg-btn:hover{
      background:#1c1e24;
    }
    main{
      padding:20px 8px 100px;
      max-width:100%;
    }
    .view{display:none;}
    .view.active{display:block;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40% 20% auto;
      height:120px;
      background:radial-gradient(ellipse at 50% 0,rgba(193,255,114,.15),transparent 60%);
      opacity:.4;
      pointer-events:none;
    }
    .listing-image{
      width:100%;
      height:180px;
      object-fit:cover;
      border-radius:12px;
      border:1px solid var(--line);
      margin-bottom:10px;
      display:block;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:16px;
    }
    .row{display:flex;align-items:center}
    .row.spread{justify-content:space-between}
    label{
      display:block;
      font-size:12px;
      font-weight:700;
      margin-bottom:6px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    input,textarea,select{
      width:100%;
      background:#141518;
      border:1px solid var(--line);
      color:var(--fg);
      padding:10px 12px;
      border-radius:10px;
      font-size:13px;
      font-family:inherit;
      outline:none;
      transition:border .2s;
    }
    input:focus,textarea:focus,select:focus{
      border-color:var(--purple);
    }
    textarea{resize:vertical;min-height:80px}
    .muted{color:var(--muted);font-size:12px}
    .sub{color:var(--muted);font-size:13px}
    .badge{
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.05em;
      border:1px solid rgba(193,255,114,.7);
      color:var(--neon);
      background:rgba(193,255,114,.11);
    }
    .chip{
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#14151a;
    }
    .accent{color:var(--neon)}
    nav{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:rgba(5,5,8,.92);
      backdrop-filter:blur(18px);
      border-top:1px solid var(--line);
      padding:10px 8px 10px;
      display:flex;
      justify-content:space-around;
      z-index:20;
    }
    .nav-btn{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:11px;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      color:var(--muted);
      transition:all .2s;
    }
    .nav-btn svg{
      width:22px;
      height:22px;
      fill:currentColor;
    }
    .nav-btn.active{
      color:var(--neon);
      background:rgba(193,255,114,.11);
    }
    .hero{
      padding:50px 0 40px;
      text-align:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:5px 11px;
      border-radius:999px;
      background:rgba(193,255,114,.11);
      color:var(--neon);
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:16px;
    }
    .pill-dot{
      width:7px;
      height:7px;
      border-radius:50%;
      background:var(--neon);
      box-shadow:0 0 12px rgba(193,255,114,1);
    }
    .headline{
      font-size:54px;
      font-weight:900;
      letter-spacing:-.8px;
      line-height:1;
      margin:0 0 14px 0;
    }
    .tagline{
      font-size:15px;
      color:var(--muted);
      max-width:600px;
      margin:0 auto 24px;
      line-height:1.6;
    }
    .cta-group{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .metrics{
      display:flex;
      gap:20px;
      justify-content:center;
      margin-top:40px;
      flex-wrap:wrap;
    }
    .metric{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .metric-value{
      font-size:28px;
      font-weight:900;
      color:var(--neon);
    }
    .metric-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.1em;
    }
    .hero-right{
      margin-top:48px;
      background:#0e0f15;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:30px 32px 34px;
      position:relative;
      overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.4);
    }
    .hero-right::before{
      content:"";
      position:absolute;
      inset:-60% 15% auto;
      height:180px;
      background:radial-gradient(ellipse at 50% 0,rgba(193,255,114,.25),transparent 60%);
      opacity:1;
      mix-blend-mode:screen;
      pointer-events:none;
      filter:blur(20px);
    }
    .hero-right-title{
      font-size:17px;
      font-weight:800;
      margin-bottom:12px;
      text-align:center;
      letter-spacing:-.3px;
      line-height:1.3;
    }
    .hero-list{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      font-size:13px;
      line-height:1.6;
    }
    .hero-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--neon);
      box-shadow:0 0 16px rgba(193,255,114,.9), 0 0 4px rgba(193,255,114,1);
      flex-shrink:0;
    }
    .tagline-glow{
      font-size:11px;
      color:var(--neon);
      text-transform:uppercase;
      letter-spacing:.18em;
      margin-bottom:6px;
      font-weight:700;
      text-shadow:0 0 20px rgba(193,255,114,.6);
    }
    .section-title{
      font-size:16px;
      font-weight:800;
      margin-bottom:8px;
      margin-top:4px;
    }
    .section-eyebrow{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
      margin-bottom:6px;
    }
    .list{display:flex;flex-direction:column;gap:12px}
    .list-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#0f1013;
    }
    .list-item.clickable{cursor:pointer}
    .avatar{
      width:40px;
      height:40px;
      border-radius:50%;
      background:radial-gradient(circle at 0 0,#5e17eb,#171821);
      display:grid;
      place-items:center;
      font-weight:800;
      color:#e2e2e8;
    }
    .bubble{
      max-width:70%;
      padding:10px 12px 6px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      font-size:13px;
      line-height:1.4;
    }
    .bubble.me{background:var(--purple)}
    .bubble.them{background:#171821}
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:30;
    }
    .modal .sheet{
      background:#111216;
      border:1px solid var(--line);
      border-radius:18px;
      width:min(780px,92vw);
      padding:18px;
      box-shadow:0 24px 55px rgba(0,0,0,.6);
      color:var(--fg);
      position:relative;
      overflow:hidden;
      max-height:90vh;
      overflow-y:auto;
    }
    .modal .sheet::before{
      content:"";
      position:absolute;
      inset:-40% 10% auto;
      height:140px;
      background:radial-gradient(circle at 30% 0,rgba(193,255,114,.2),transparent 55%);
      opacity:.7;
      pointer-events:none;
    }
    .pill-warning{
      font-size:11px;
      color:var(--danger);
    }
    .auth-tabs{
      display:flex;
      gap:6px;
      padding:4px;
      border-radius:999px;
      background:#060608;
      border:1px solid var(--line);
      margin-bottom:12px;
      width:max-content;
    }
    .auth-tab{
      padding:6px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      color:var(--muted);
    }
    .auth-tab.active{
      background:var(--purple);
      color:white;
    }
    .error-text{
      color:var(--danger);
      font-size:12px;
      margin-top:4px;
    }
    .reveal{
      opacity:0;
      transform:translateY(24px);
      transition:opacity .8s cubic-bezier(0.4, 0, 0.2, 1), transform .8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .reveal.in{
      opacity:1;
      transform:none;
    }
    @media(min-width:880px){
      .headline{font-size:68px;letter-spacing:-1px;}
    }
    @media(max-width:820px){
      .hero{
        padding:40px 0 30px;
      }
    }
    @media(max-width:720px){
      header{
        padding-inline:8px;
        gap:10px;
      }
      .header-center{display:none;}
      .brand-name{font-size:20px}
      .headline{font-size:40px;letter-spacing:-.6px;}
      .hero-right{
        padding:24px 28px 28px;
        margin-top:40px;
      }
      .story-mission-grid{
        grid-template-columns:1fr !important;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">c</div>
        <div>
          <div class="brand-name">connectr<span style="color:var(--neon)">+</span></div>
          <div class="brand-tag">Campus marketplace, reimagined</div>
        </div>
      </div>
      <div class="header-center">
        <button class="btn ghost small" onclick="go('home')">Home</button>
        <button class="btn ghost small" onclick="go('search')">Browse</button>
        <button id="btnHeaderPost" class="btn purple small" onclick="onRequireAuth(()=>go('post'))">
          New listing
        </button>
      </div>
      <div class="header-auth" id="headerAuth"></div>
    </header>
    <main>
      <!-- HOME -->
      <section id="home" class="view active">
        <div class="hero">
          <div class="pill">
            <span class="pill-dot"></span>
            <span>connectr+ marketplace</span>
          </div>
          <h1 class="headline">Connect your <span style="color:var(--neon)">campus</span> in<br/>one trusted marketplace.</h1>
          <p class="tagline">
            Browse, list, and buy instantly. Built for students, optimised for trust. 
            No auctions, no stress â€” just straightforward peer-to-peer trade within your university.
          </p>
          <div class="metrics">
            <div class="metric">
              <div class="metric-value" id="metricListings">0</div>
              <div class="metric-label">Active listings</div>
            </div>
            <div class="metric">
              <div class="metric-value">100%</div>
              <div class="metric-label">Instant buy</div>
            </div>
            <div class="metric">
              <div class="metric-value">0%</div>
              <div class="metric-label">Bidding drama</div>
            </div>
          </div>
          <div class="hero-right" id="heroAuthBox">
            <div class="tagline-glow" style="text-align:center;position:relative;z-index:1;">How it works</div>
            <div class="hero-right-title" style="position:relative;z-index:1;">
              Find what you need.<br/>No login required.
            </div>
            <div class="hero-list" style="position:relative;z-index:1;">
              <div class="row" style="gap:10px">
                <div class="hero-dot"></div>
                <div>Search first â€” explore without an account.</div>
              </div>
              <div class="row" style="gap:10px">
                <div class="hero-dot"></div>
                <div>Sign in once to unlock posting, favourites, messaging, and instant buying.</div>
              </div>
              <div class="row" style="gap:10px">
                <div class="hero-dot"></div>
                <div>One tap to own it. No haggling, no surprises.</div>
              </div>
            </div>
            <div class="cta-group" style="margin-top:24px;position:relative;z-index:1;">
              <button class="btn neon" onclick="openAuthModal('login')">Get started</button>
              <button class="btn ghost" onclick="openAuthModal('login')">I already have an account</button>
            </div>
          </div>
        </div>
        <div class="story-mission-grid reveal" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:40px;">
          <div class="card">
            <div class="section-eyebrow">Our story</div>
            <div class="section-title">BUILT BY <span class="accent">STUDENTS</span>, FOR STUDENTS</div>
            <p class="sub" style="font-size:13px;margin-top:8px;">
              We're IE University students who lived through the frustrations of buying and selling 
              on campus. We built connectr+ to bring transparency, convenience, and trust 
              into campus commerce â€” no third-party auctions, no hidden bids. 
              Just students helping students.
            </p>
            <ul style="margin:14px 0 0 15px;font-size:13px;color:var(--muted);padding-left:4px;line-height:1.8;">
              <li>Born from real campus frustrations and challenges</li>
              <li>Designed with student budgets and schedules in mind</li>
              <li>Built to foster trust within your university community</li>
              <li>No corporate middlemen taking cuts from your sales</li>
              <li>Empowering students to support each other directly</li>
            </ul>
          </div>
          <div class="card">
            <div class="section-eyebrow">Our mission</div>
            <div class="section-title">BUILD A <span class="accent">CIRCULAR</span>, STUDENT-POWERED CAMPUS ECONOMY</div>
            <p class="sub" style="font-size:13px;margin-top:8px;">
              Our mission is to make student life more circular, not more wasteful. 
              Every feature of connectr+ is designed to extend the life of what already exist...
              keeping textbooks, tickets, and tech in use for longer, reducing waste, 
              and keeping more value within your campus community.
            </p>
            <ul style="margin:14px 0 0 15px;font-size:13px;color:var(--muted);padding-left:4px;line-height:1.8;">
              <li>Browse without logging in â€“ no friction.</li>
              <li>Log in once to unlock favourites, messages, and instant buying.</li>
              <li>Clear pricing, no hidden auctions, no surprise bids.</li>
            </ul>
          </div>
        </div>
        <div class="card reveal" style="margin-top:40px; padding-bottom:30px;">
          <div class="row spread">
            <div>
              <div class="section-eyebrow">Discover</div>
              <h3 style="margin:2px 0 0 0">Trending listings</h3>
            </div>
            <div class="muted">Browse now â€“ log in later to buy.</div>
          </div>
          <div id="trendingGrid" class="grid" style="margin-top:10px"></div>
        </div>
      </section>
      <!-- SEARCH -->
      <section id="search" class="view">
        <div class="card reveal">
          <div class="row" style="gap:10px;align-items:flex-end;flex-wrap:wrap;">
            <div style="flex:1 1 240px;">
              <label>Search marketplace</label>
              <input id="searchInput" type="text" placeholder="Search by keyword, category, or descriptionâ€¦"/>
            </div>
            <div style="flex:0 0 auto;display:flex;gap:8px;">
              <button class="btn purple" onclick="runSearch()">Search</button>
              <button class="btn ghost" onclick="clearSearch()">Clear</button>
            </div>
          </div>
          <div class="muted" style="font-size:12px;margin-top:6px;">
            You can look around without an account. To post, favourite, message or buy, please log in.
          </div>
        </div>
        <div id="searchResults" class="grid reveal" style="margin-top:16px"></div>
      </section>
      <!-- FAVOURITES -->
      <section id="favourites" class="view">
        <div class="row spread reveal" style="margin-bottom:12px">
          <h3 style="margin:0">Your favourites</h3>
          <button class="btn small" onclick="clearFavourites()">Clear all</button>
        </div>
        <div id="favGrid" class="grid reveal"></div>
      </section>
      <!-- POST -->
      <section id="post" class="view">
        <div class="card reveal">
          <div class="row spread" style="margin-bottom:4px;">
            <h3 style="margin:0 0 8px 0">Create a listing</h3>
            <div class="muted" style="font-size:12px;">Share something you want to sell or pass on.</div>
          </div>
          <div class="grid" style="grid-template-columns:1fr;">
            <div class="row" style="align-items:flex-start; gap:16px; flex-wrap:wrap">
              <div style="flex:1 1 320px">
                <label>Title</label>
                <input id="p_title" type="text" placeholder="Give your listing a clear title"/>
              </div>
              <div style="flex:1 1 220px">
                <label>Category</label>
                <select id="p_category">
                  <option value="Books & Textbooks">Books & Textbooks</option>
                  <option value="Electronics">Electronics</option>
                  <option value="Furniture">Furniture</option>
                  <option value="Clothing & Accessories">Clothing & Accessories</option>
                  <option value="Tickets & Events">Tickets & Events</option>
                  <option value="Sports & Fitness">Sports & Fitness</option>
                  <option value="Art & Supplies">Art & Supplies</option>
                  <option value="Kitchen & Appliances">Kitchen & Appliances</option>
                  <option value="Bikes & Transportation">Bikes & Transportation</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div>
              <label>Description</label>
              <textarea id="p_desc" placeholder="Describe the item, its condition, and any details students should knowâ€¦"></textarea>
            </div>
            <div>
              <label>Photo (optional)</label>
              <input id="p_image" type="file" accept="image/*"/>
              <div id="imagePreview" style="margin-top:12px;max-width:300px;"></div>
            </div>
            <div class="row" style="gap:16px; flex-wrap:wrap">
              <div style="flex:1 1 160px">
                <label>Price (instant buy)</label>
                <input id="p_price" type="number" min="0" step="0.01" placeholder="0.00"/>
              </div>
            </div>
            <div class="row" style="gap:10px; margin-top:6px">
              <button class="btn neon" onclick="submitListing()">Publish listing</button>
              <div class="muted" style="font-size:11px;">
                By publishing, you agree that buyers can instantly secure your item at the listed price.
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- MESSAGES -->
      <section id="messages" class="view">
        <div class="row spread reveal" style="margin-bottom:10px">
          <div>
            <div class="section-eyebrow">Inbox</div>
            <h3 style="margin:2px 0 0 0">Messages</h3>
          </div>
          <div class="muted">Newest first</div>
        </div>
        <div id="msgList" class="list reveal"></div>
      </section>
      <!-- PROFILE -->
      <section id="profile" class="view">
        <div class="card reveal">
          <h3 style="margin:0 0 12px 0">Your profile</h3>
          <div class="row" style="gap:16px; align-items:flex-start; flex-wrap:wrap">
            <div class="row" style="gap:12px">
              <div class="avatar" id="avatar">U</div>
              <div>
                <label>Name</label>
                <input id="pf_name" type="text" placeholder="Your name"/>
                <div class="muted" style="margin-top:4px;font-size:12px;">
                  Member since <span id="pf_since">â€“</span>
                </div>
              </div>
            </div>
          </div>
          <div class="row" style="gap:12px; margin-top:12px; flex-wrap:wrap">
            <div style="flex:1 1 200px">
              <label>Location</label>
              <div style="position:relative;">
                <input id="pf_location" type="text" placeholder="Search for your suburb..." 
                       oninput="filterLocations()" 
                       onfocus="document.getElementById('locationDropdown').style.display='block'"
                       autocomplete="off"/>
                <div id="locationDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#141518;border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;max-height:200px;overflow-y:auto;z-index:5;">
                  <!-- Locations will be populated by JS -->
                </div>
              </div>
            </div>
            <div style="flex:1 1 200px">
              <label>University</label>
              <select id="pf_university">
                <option value="">Select your campus</option>
                <option value="IE University - Segovia Campus">IE University - Segovia Campus</option>
                <option value="IE University - Tower">IE University - Tower</option>
                <option value="IE University - Maria De Molina">IE University - Maria De Molina</option>
              </select>
            </div>
          </div>
          <div class="row" style="gap:10px; margin-top:12px">
            <button class="btn purple" onclick="saveProfile()">Save profile</button>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;" class="reveal">
          <div class="card">
            <div class="row spread">
              <div class="muted">Your listings</div>
              <div id="stat_mylistings">0</div>
            </div>
          </div>
          <div class="card">
            <div class="row spread">
              <div class="muted">Total favourites</div>
              <div id="stat_favs">0</div>
            </div>
          </div>
        </div>
        <div class="card reveal" style="margin-top:16px;">
          <div class="row spread">
            <div>
              <div class="section-eyebrow">Manage</div>
              <h3 style="margin:2px 0 0 0">My listings</h3>
            </div>
            <div class="muted">Edit or delete your posts</div>
          </div>
          <div id="myListingsGrid" class="grid" style="margin-top:10px"></div>
        </div>
      </section>
      <nav>
        <div class="nav-btn active" data-view="home" onclick="switchView(this)">
          <svg viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
          Home
        </div>
        <div class="nav-btn" data-view="search" onclick="switchView(this)">
          <svg viewBox="0 0 24 24"><path d="M10 18a8 8 0 1 1 5.29-14.06L22 10.65l-1.41 1.41-3.7-3.7A8 8 0 0 1 10 18z"/></svg>
          Search
        </div>
        <div class="nav-btn" data-view="favourites" onclick="switchView(this)">
          <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5A4.5 4.5 0 0 1 6.5 4c1.74 0 3.41.81 4.5 2.09A6 6 0 0 1 22 8.5c0 3.78-3.4 6.86-8.55 11.54z"/></svg>
          Favourites
        </div>
        <div class="nav-btn" data-view="messages" onclick="switchView(this)">
          <svg viewBox="0 0 24 24"><path d="M21 6h-18v12h4v4l6-4h8z"/></svg>
          Messages
        </div>
        <div class="nav-btn" data-view="profile" onclick="switchView(this)">
          <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
          Profile
        </div>
      </nav>
    </main>
  </div>
  <!-- Listing modal -->
  <div id="listingModal" class="modal" onclick="backdropClose(event)">
    <div class="sheet">
      <div class="row spread" style="position:relative;z-index:1;">
        <div>
          <div class="section-eyebrow">Listing</div>
          <h3 id="lm_title" style="margin:2px 0 0 0"></h3>
        </div>
        <button class="btn icon-only" onclick="closeModal('listingModal')">âœ•</button>
      </div>
      <div id="lm_image" style="margin:12px 0;"></div>
      <div id="lm_desc" class="muted" style="margin:8px 0 14px 0"></div>
      <div id="lm_price" style="font-size:18px;font-weight:800;margin-bottom:4px;"></div>
      <div id="lm_meta" class="muted" style="margin-top:2px;font-size:12px;"></div>
    <div id="lm_actions" class="row" style="gap:10px; flex-wrap:wrap; margin-top:14px;position:relative;z-index:1;">
</div>
<span class="pill-warning" id="lm_guestHint" style="display:none;margin-top:8px;"></span>
    </div>
  </div>
  <!-- Edit Listing Modal -->
  <div id="editListingModal" class="modal" onclick="backdropClose(event)">
    <div class="sheet">
      <div class="row spread" style="position:relative;z-index:1;margin-bottom:8px;">
        <div>
          <div class="section-eyebrow">Edit</div>
          <h3 style="margin:2px 0 0 0">Update your listing</h3>
        </div>
        <button class="btn icon-only" onclick="closeModal('editListingModal')">âœ•</button>
      </div>
      <div class="grid" style="grid-template-columns:1fr;position:relative;z-index:1;">
        <div class="row" style="align-items:flex-start; gap:16px; flex-wrap:wrap">
          <div style="flex:1 1 320px">
            <label>Title</label>
            <input id="e_title" type="text" placeholder="Title"/>
          </div>
          <div style="flex:1 1 220px">
            <label>Category</label>
            <select id="e_category">
              <option value="Books & Textbooks">Books & Textbooks</option>
              <option value="Electronics">Electronics</option>
              <option value="Furniture">Furniture</option>
              <option value="Clothing & Accessories">Clothing & Accessories</option>
              <option value="Tickets & Events">Tickets & Events</option>
              <option value="Sports & Fitness">Sports & Fitness</option>
              <option value="Art & Supplies">Art & Supplies</option>
              <option value="Kitchen & Appliances">Kitchen & Appliances</option>
              <option value="Bikes & Transportation">Bikes & Transportation</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div>
          <label>Description</label>
          <textarea id="e_desc" placeholder="Description"></textarea>
        </div>
        <div class="row" style="gap:16px; flex-wrap:wrap">
          <div style="flex:1 1 160px">
            <label>Price</label>
            <input id="e_price" type="number" min="0" step="0.01" placeholder="0.00"/>
          </div>
        </div>
        <div class="row" style="gap:10px; margin-top:6px">
          <button class="btn neon" onclick="submitEditListing()">Save changes</button>
          <button class="btn ghost" onclick="closeModal('editListingModal')">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Chat modal -->
  <div id="chatModal" class="modal" onclick="backdropClose(event)">
    <div class="sheet">
      <div class="row spread" style="position:relative;z-index:1;">
        <h3 id="chatTitle" style="margin:0"></h3>
        <button class="btn icon-only" onclick="closeModal('chatModal')">âœ•</button>
      </div>
      <div id="chatThread" style="display:flex;flex-direction:column;gap:10px;margin:12px 0;max-height:45vh;overflow:auto"></div>
      <div class="row" style="gap:8px;position:relative;z-index:1;">
        <input id="chatInput" type="text" placeholder="Write a messageâ€¦"/>
        <button class="btn purple" onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>
  <!-- Auth modal -->
  <div id="authModal" class="modal" onclick="backdropClose(event)">
    <div class="sheet" style="max-width:480px;">
      <div class="row spread" style="position:relative;z-index:1;margin-bottom:8px;">
        <div>
          <div class="section-eyebrow" id="authEyebrow">Welcome</div>
          <h3 id="authTitle" style="margin:2px 0 0 0">Log in</h3>
        </div>
        <button class="btn icon-only" onclick="closeModal('authModal')">âœ•</button>
      </div>
      <div class="auth-tabs">
        <div id="tabLogin" class="auth-tab active" onclick="switchAuthMode('login')">Log in</div>
        <div id="tabRegister" class="auth-tab" onclick="switchAuthMode('register')">Register</div>
      </div>
      <div id="authFormLogin">
        <div style="margin-bottom:8px;">
          <label>Email</label>
          <input id="login_email" type="email" placeholder="you@university.edu"/>
        </div>
        <div style="margin-bottom:6px;">
          <label>Password</label>
          <input id="login_password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <div id="loginError" class="error-text" style="display:none;"></div>
        <button class="btn neon" style="margin-top:10px;width:100%;" onclick="submitLogin()">Log in</button>
      </div>
      <div id="authFormRegister" style="display:none;">
        <div style="margin-bottom:8px;">
          <label>Name</label>
          <input id="reg_name" type="text" placeholder="Your name"/>
        </div>
        <div style="margin-bottom:8px;">
          <label>Email</label>
          <input id="reg_email" type="email" placeholder="you@university.edu"/>
        </div>
        <div style="margin-bottom:8px;">
          <label>Password</label>
          <input id="reg_password" type="password" placeholder="Create a password"/>
        </div>
        <div style="margin-bottom:6px;">
          <label>University</label>
          <input id="reg_university" type="text" placeholder="University name"/>
        </div>
        <div id="registerError" class="error-text" style="display:none;"></div>
        <button class="btn neon" style="margin-top:10px;width:100%;" onclick="submitRegister()">Create account</button>
      </div>
      <div class="muted" style="font-size:11px;margin-top:10px;">
        Once logged in you can post listings, favourite items, start chats with sellers,
        and buy instantly at the listed price.
      </div>
    </div>
  </div>
  <script>
    console.log('Script starting...');
    
    const AUTH_BASE = "https://users-svc.bluecoast-b88fe4f5.northeurope.azurecontainerapps.io";
    const LISTINGS_BASE = 'https://listings-svc.bluecoast-b88fe4f5.northeurope.azurecontainerapps.io';
    
    const API_AUTH_REGISTER = AUTH_BASE + '/auth/register';
    const API_AUTH_LOGIN = AUTH_BASE + '/auth/login';
    const API_AUTH_ME = AUTH_BASE + '/auth/me';
    
    const API_LISTINGS = LISTINGS_BASE + '/listings';
    const API_MY_LISTINGS = LISTINGS_BASE + '/listings/my';
    const API_LISTING = (id) => LISTINGS_BASE + '/listings/' + id;
    const API_BUY = (id) => LISTINGS_BASE + '/listings/' + id + '/buy';
    const API_FAVOURITES = LISTINGS_BASE + '/favourites';
    const API_FAVOURITE = (id) => LISTINGS_BASE + '/favourites/' + id;
    const API_CHAT_ROOMS = LISTINGS_BASE + '/chat/rooms';
    const API_CHAT_MESSAGES = (roomId) => LISTINGS_BASE + '/chat/rooms/' + roomId + '/messages';
    const API_SEND_MESSAGE = (roomId) => LISTINGS_BASE + '/chat/rooms/' + roomId + '/messages';
    
    const state = {
      user: null,
      token: null,
      listings: [],
      myListings: [],
      favourites: [],
      chatRooms: [],
      messages: [],
      selected: null,
      editingListing: null,
      openChatId: null,
      profile: { since: new Date().toISOString(), name:'', location:'', university:'' },
    };
    
    const el  = (sel) => document.querySelector(sel);
    const els = (sel) => Array.from(document.querySelectorAll(sel));
    
    console.log('Functions defined, starting init...');
    
    /* ==================== IMAGE PREVIEW ==================== */
    
    const imageInput = el('#p_image');
    if(imageInput) {
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            el('#imagePreview').innerHTML = '<img src="' + e.target.result + '" style="width:100%;border-radius:12px;border:1px solid var(--line);"/>';
          };
          reader.readAsDataURL(file);
        } else {
          el('#imagePreview').innerHTML = '';
        }
      });
    }
    
    /* ==================== AUTH ==================== */
    
    function isAuthed(){ return !!state.user && !!state.token; }
    
    function persistAuth(){
      localStorage.setItem('cx_auth', JSON.stringify({user:state.user, token:state.token}));
    }
    
    function restoreAuth(){
      try{
        const raw = localStorage.getItem('cx_auth');
        if(!raw) return;
        const parsed = JSON.parse(raw);
        state.user = parsed.user || null;
        state.token = parsed.token || null;
      }catch(e){console.error('Restore auth error:', e);}
    }
    
    async function fetchMe(){
      if(!state.token) return;
      try{
        const res = await fetch(API_AUTH_ME,{
          headers:{'Authorization':'Bearer ' + state.token}
        });
        
        if(!res.ok) throw new Error('Failed to fetch user');
        
        const data = await res.json();
        state.user = data;
      }catch(e){
        console.error('fetchMe error:', e);
        state.user = null;
        state.token = null;
        localStorage.removeItem('cx_auth');
      }
    }
    
    function updateAuthUI(){
      const container = el('#headerAuth');
      if(!container) return;
      container.innerHTML = '';
      
      const heroAuthBox = el('#heroAuthBox');
      
      if(!isAuthed()){
        const loginBtn = document.createElement('button');
        loginBtn.className = 'btn ghost small';
        loginBtn.textContent = 'Log in';
        loginBtn.onclick = () => openAuthModal('login');
        
        const regBtn = document.createElement('button');
        regBtn.className = 'btn neon small';
        regBtn.textContent = 'Register';
        regBtn.onclick = () => openAuthModal('register');
        
        container.appendChild(loginBtn);
        container.appendChild(regBtn);
        
        if(heroAuthBox) heroAuthBox.style.display = 'block';
      }else{
        const chip = document.createElement('div');
        chip.style.display='flex';
        chip.style.alignItems='center';
        chip.style.gap='8px';
        
        const avatar = document.createElement('div');
        avatar.className='avatar';
        avatar.style.width='32px';
        avatar.style.height='32px';
        avatar.textContent = (state.user.name || state.user.email || 'U').slice(0,1).toUpperCase();
        
        const info = document.createElement('div');
        info.style.display='flex';
        info.style.flexDirection='column';
        info.style.fontSize='11px';
        info.innerHTML = '<strong>' + escapeHtml(state.user.name || 'Student') + '</strong><span class="muted">' + escapeHtml(state.user.email || '') + '</span>';
        
        const logoutBtn = document.createElement('button');
        logoutBtn.className='btn ghost small';
        logoutBtn.textContent='Log out';
        logoutBtn.onclick = logout;
        
        chip.appendChild(avatar);
        chip.appendChild(info);
        container.appendChild(chip);
        container.appendChild(logoutBtn);
        
        if(heroAuthBox) heroAuthBox.style.display = 'none';
      }
    }
    
    function logout(){
      state.user=null;
      state.token=null;
      state.favourites=[];
      state.myListings=[];
      state.chatRooms=[];
      state.messages=[];
      localStorage.removeItem('cx_auth');
      updateAuthUI();
      go('home');
      alert('You have been logged out.');
    }
    
    function openAuthModal(mode){
      clearAuthErrors();
      switchAuthMode(mode || 'login');
      openModal('authModal');
    }
    
    function switchAuthMode(mode){
      const loginTab = el('#tabLogin');
      const regTab = el('#tabRegister');
      const loginForm = el('#authFormLogin');
      const regForm = el('#authFormRegister');
      const title = el('#authTitle');
      
      if(mode === 'login'){
        loginTab.classList.add('active');
        regTab.classList.remove('active');
        loginForm.style.display = 'block';
        regForm.style.display = 'none';
        title.textContent = 'Log in';
      } else {
        regTab.classList.add('active');
        loginTab.classList.remove('active');
        regForm.style.display = 'block';
        loginForm.style.display = 'none';
        title.textContent = 'Register';
      }
    }
    
    function clearAuthErrors(){
      el('#loginError').style.display = 'none';
      el('#registerError').style.display = 'none';
    }
    
    async function submitLogin(){
      const email = el('#login_email').value.trim();
      const password = el('#login_password').value;
      const errorEl = el('#loginError');
      
      if(!email || !password){
        errorEl.textContent = 'Please fill in all fields';
        errorEl.style.display = 'block';
        return;
      }
      
      try{
        const res = await fetch(API_AUTH_LOGIN, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email, password })
        });
        
        if(!res.ok){
          const text = await res.text();
          throw new Error(text || 'Login failed');
        }
        
        const data = await res.json();
        state.token = data.access_token || data.token;
        
        if(!state.token) throw new Error('No token received');
        
        await fetchMe();
        persistAuth();
        
        await loadListings();
        await syncFavourites();
        await loadMyListings();
        await loadMessages();
        
        closeModal('authModal');
        updateAuthUI();
      }catch(e){
        console.error('Login error:', e);
        errorEl.textContent = e.message || 'Login failed';
        errorEl.style.display = 'block';
      }
    }
    
    async function submitRegister(){
      const name = el('#reg_name').value.trim();
      const email = el('#reg_email').value.trim();
      const password = el('#reg_password').value;
      const university = el('#reg_university').value.trim();
      const errorEl = el('#registerError');
      
      if(!name || !email || !password || !university){
        errorEl.textContent = 'Please fill in all fields';
        errorEl.style.display = 'block';
        return;
      }
      
      try{
        const res = await fetch(API_AUTH_REGISTER, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name, email, password, university })
        });
        
        if(!res.ok){
          const text = await res.text();
          throw new Error(text || 'Registration failed');
        }
        
        alert('Account created! Please log in.');
        switchAuthMode('login');
      }catch(e){
        console.error('Registration error:', e);
        errorEl.textContent = e.message || 'Registration failed';
        errorEl.style.display = 'block';
      }
    }
    
    /* ==================== NAVIGATION & VIEWS ==================== */
    
    function go(viewId){
      const views = els('.view');
      views.forEach(v => v.classList.remove('active'));
      
      const target = el('#' + viewId);
      if(target) target.classList.add('active');
      
      const navBtns = els('.nav-btn');
      navBtns.forEach(n => n.classList.remove('active'));
      
      const navBtn = els('.nav-btn').find(n => n.dataset.view === viewId);
      if(navBtn) navBtn.classList.add('active');
      
      if(viewId === 'home') renderHome();
      if(viewId === 'search') runSearch();
      if(viewId === 'favourites') renderFavourites();
      if(viewId === 'messages') renderMessages();
      if(viewId === 'profile') renderProfileStats();
      
      observeAll();
    }
    
    function switchView(btn){
      const view = btn.dataset.view;
      go(view);
    }
    
    function onRequireAuth(callback){
      if(!isAuthed()){
        openAuthModal('login');
      } else {
        callback();
      }
    }
    
    /* ==================== MODALS ==================== */
    
    function openModal(id){
      const modal = el('#' + id);
      if(modal) modal.style.display = 'flex';
    }
    
    function closeModal(id){
      const modal = el('#' + id);
      if(modal) modal.style.display = 'none';
    }
    
    function backdropClose(e){
      if(e.target.classList.contains('modal')){
        e.target.style.display = 'none';
      }
    }
    
    /* ==================== LISTINGS ==================== */
    
    async function loadListings(){
      try{
        const res = await fetch(API_LISTINGS);
        if(!res.ok) throw new Error('Failed to load listings');
        
        const data = await res.json();
        state.listings = Array.isArray(data) ? data : (data.items || []);
        
        console.log('Loaded listings:', state.listings.length);
      }catch(e){
        console.error('Load listings error:', e);
        state.listings = [];
      }
    }
    
    async function loadMyListings(){
      if(!isAuthed()){
        state.myListings = [];
        return;
      }
      
      try{
        const res = await fetch(API_MY_LISTINGS, {
          headers: {'Authorization': 'Bearer ' + state.token}
        });
        if(!res.ok) throw new Error('Failed to load my listings');
        
        const data = await res.json();
        state.myListings = Array.isArray(data) ? data : (data.items || []);
        
        console.log('Loaded my listings:', state.myListings.length);
      }catch(e){
        console.error('Load my listings error:', e);
        state.myListings = [];
      }
      renderMyListings();
      renderProfileStats();
    }
    
    function renderHome(){
      const trg = el('#trendingGrid');
      const items = state.listings.slice(0,8);
      trg.innerHTML = items.map(renderListingCard).join('') ||
        '<div class="muted">No listings yet. Log in and create the first one!</div>';
      el('#metricListings').textContent = state.listings.length;
    }
    
    function runSearch(){
      const searchInput = el('#searchInput');
      if(!searchInput) return;
      
      const q = (searchInput.value||'').toLowerCase().trim();
      console.log('Search query:', q, 'Listings:', state.listings.length);
      
      const res = !q
        ? state.listings
        : state.listings.filter(x=>
            (x.title||'').toLowerCase().includes(q) ||
            (x.category||'').toLowerCase().includes(q) ||
            (x.description||'').toLowerCase().includes(q)
          );
      
      el('#searchResults').innerHTML = res.map(renderListingCard).join('') ||
        '<div class="muted">No results. Try another keyword.</div>';
      observeAll();
    }
    
    function clearSearch(){
      const searchInput = el('#searchInput');
      if(!searchInput) return;
      searchInput.value='';
      runSearch();
    }
    
    function renderListingCard(l){
      const fav=isFav(l.id);
      const isSold = l.status === 'sold';
      const isMyListing = isAuthed() && state.user && state.user.user_id && l.sellerId === state.user.user_id;
      const priceStr = isSold ? 'Sold' :
        (l.price > 0 ? 'â‚¬' + Number(l.price).toFixed(2) : 'Free / swap');
      
      const soldBadge = isSold
        ? '<span class="badge" style="border-color:rgba(255,77,106,.7);color:var(--danger);background:rgba(56,14,24,.7);">Sold</span>'
        : '<span class="badge">Instant buy</span>';
      
      const imageHtml = l.imageUrl 
        ? '<img src="' + escapeHtml(l.imageUrl) + '" class="listing-image" alt="' + escapeHtml(l.title) + '"/>'
        : '';
      
      let actionButtons = '';
      if (isMyListing) {
        actionButtons = `
          <button class="btn purple small" onclick="editListing('${l.id}')">Edit</button>
          <button class="btn danger small" onclick="deleteListing('${l.id}')">Delete</button>
        `;
      } else {
        const messageBtn = !isSold && isAuthed() ? `<button class="btn ghost small" onclick="event.stopPropagation();messageSeller('${l.id}')">ðŸ’¬ Message</button>` : '';
        actionButtons = `
          <button class="btn neon small" onclick="openListing('${l.id}')">View details</button>
          ${messageBtn}
        `;
      }

      const favButton = !isMyListing ? `
        <button class="seg-btn" 
                style="padding:6px 10px;font-size:16px;${fav?'border-color:var(--purple);color:var(--neon);font-weight:800;background:rgba(193,255,114,.15);':''}transition:all .2s;" 
                onclick="event.stopPropagation();toggleFav('${l.id}')" 
                onmouseover="this.style.transform='scale(1.1)'" 
                onmouseout="this.style.transform='scale(1)'"
                ${!isAuthed()?'title="Log in to save favourites"':'title="'+(fav?'Remove from favourites':'Add to favourites')+'"'}>
          ${fav?'â˜…':'â˜†'}
        </button>
      ` : '';
      
      return '<div class="card reveal">' +
        imageHtml +
        '<div class="row spread" style="position:relative;z-index:1;">' +
          '<div style="font-weight:800;font-size:14px;max-width:78%;">' +
            escapeHtml(l.title) +
          '</div>' +
          favButton +
        '</div>' +
        '<div class="row spread" style="position:relative;z-index:1;">' +
          '<div class="muted" style="font-size:12px;">' + escapeHtml(l.category || 'Misc') + '</div>' +
          soldBadge +
        '</div>' +
        '<div class="row spread" style="margin-top:4px;position:relative;z-index:1;">' +
          '<div style="font-size:18px; font-weight:800">' + priceStr + '</div>' +
        '</div>' +
        '<div class="row" style="gap:8px;margin-top:6px;position:relative;z-index:1;flex-wrap:wrap;">' +
          actionButtons +
        '</div>' +
      '</div>';
    }
    
    function renderMyListings(){
      const grid = el('#myListingsGrid');
      if(!grid) return;
      
      grid.innerHTML = state.myListings.map(l => renderListingCard(l)).join('') ||
        '<div class="muted">You haven\'t posted any listings yet. Click "New listing" to get started!</div>';
    }
    
    function openListing(id){
  const l=state.listings.find(x=>x.id===id);
  if(!l) return;
  state.selected=l;
  
  const isMyListing = isAuthed() && state.user && state.user.user_id && l.sellerId === state.user.user_id;
  const isSold = l.status === 'sold';
  
  el('#lm_title').textContent=l.title;
  el('#lm_desc').textContent=l.description||'â€”';
  
  const imageContainer = el('#lm_image');
  if(l.imageUrl) {
    imageContainer.innerHTML = '<img src="' + escapeHtml(l.imageUrl) + '" style="width:100%;max-height:400px;object-fit:cover;border-radius:12px;border:1px solid var(--line);"/>';
  } else {
    imageContainer.innerHTML = '';
  }
  
  const priceStr = isSold ? 'Already sold' :
    (l.price > 0 ? 'â‚¬' + Number(l.price).toFixed(2) : 'Free / swap');
  el('#lm_price').textContent = priceStr;
  
  const sellerName = l.sellerName || (l.seller && l.seller.includes('@') ? l.seller.split('@')[0] : 'Unknown seller');
  el('#lm_meta').textContent = [
    'Seller: ' + sellerName,
    l.category ? 'Category: ' + l.category : null,
    l.createdAt ? 'Posted ' + timeAgo(new Date(l.createdAt).getTime()) : null,
  ].filter(Boolean).join(' â€¢ ');
  
  const actionButtons = el('#lm_actions');
  const guestHint = el('#lm_guestHint');
  
  actionButtons.innerHTML = '';
  guestHint.style.display = 'none';
  
  if(isMyListing){
    actionButtons.innerHTML = `
      <button class="btn purple" onclick="editListingFromModal('${l.id}')">Edit listing</button>
      <button class="btn danger" onclick="deleteListingFromModal('${l.id}')">Delete listing</button>
      <span class="muted" style="font-size:11px;">This is your listing</span>
    `;
  } else if(isSold){
    actionButtons.innerHTML = `
      <button class="btn" disabled style="opacity:0.5;">Sold</button>
      <span class="muted" style="font-size:11px;">This item has been sold</span>
    `;
  } else if(!isAuthed()){
    actionButtons.innerHTML = `
      <button class="btn neon" onclick="openAuthModal('login')">Log in to buy</button>
    `;
    guestHint.textContent = 'Sign in to purchase this item and start a chat with the seller';
    guestHint.style.display = 'block';
  } else {
    const isFavourited = isFav(l.id);
    actionButtons.innerHTML = `
      <button class="btn neon" onclick="buyNow('${l.id}')">Buy now for ${priceStr}</button>
      <button class="btn ghost" onclick="messageSeller('${l.id}')">ðŸ’¬ Message seller</button>
      <button class="btn ghost" onclick="toggleFav('${l.id}');openListing('${l.id}')" style="padding:9px 16px;">
        ${isFavourited ? 'â˜… Saved' : 'â˜† Save to favourites'}
      </button>
      <span class="muted" style="font-size:11px;">Buy for instant chat with automated welcome, or message first to ask questions.</span>
    `;
  }
  
  openModal('listingModal');
}

    function editListingFromModal(id){
      closeModal('listingModal');
      editListing(id);
    }
    
    function deleteListingFromModal(id){
      closeModal('listingModal');
      deleteListing(id);
    }
    
    async function buyNow(id){
      if(!isAuthed()){
        openAuthModal('login');
        return;
      }
      
      const listing = state.listings.find(l => l.id === id);
      if(!listing) return;
      
      if(!confirm(`Buy "${listing.title}" for â‚¬${Number(listing.price).toFixed(2)}?\n\nA chat will be created automatically with the seller and an automated welcome message will be sent!`)) return;
      
      try{
        const res = await fetch(API_BUY(id), {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+state.token
          },
          body:JSON.stringify({})
        });
        if(!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Purchase failed');
        }
        
        // Reload all data to get the new chat room and updated listing
        await loadListings();
        await loadMessages();
        await loadMyListings();
        
        closeModal('listingModal');
        
        // Navigate to messages to see the new chat
        go('messages');
        
        alert('âœ… Purchase completed!\n\n' + 
              'ðŸ“¦ Item "' + listing.title + '" is now yours\n' +
              'ðŸ’¬ Chat created with seller - check your Messages!\n' +
              'ðŸŽ‰ An automated welcome message has been sent\n\n' +
              'Coordinate pickup/delivery in your Messages tab.');
      }catch(e){
        console.error(e);
        alert('âŒ Could not complete purchase: ' + (e.message || 'Please try again.'));
      }
    }
    
    async function messageSeller(listingId){
      if(!isAuthed()){
        openAuthModal('login');
        return;
      }
      
      const listing = state.listings.find(l => l.id === listingId);
      if(!listing) return;
      
      try{
        // Check if a chat room already exists for this listing
        await loadMessages();
        
        const existingChat = state.chatRooms.find(room => 
          room.listingId === listingId && 
          (room.buyerEmail === state.user.email || room.sellerEmail === state.user.email)
        );
        
        if(existingChat){
          // Chat already exists, open it
          closeModal('listingModal');
          go('messages');
          setTimeout(() => openChat(existingChat.id), 300);
          return;
        }
        
        // Create a new chat room without buying
        const res = await fetch(LISTINGS_BASE + '/chat/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.token
          },
          body: JSON.stringify({
            listingId: listingId
          })
        });
        
        if(!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Could not create chat');
        }
        
        const newChat = await res.json();
        
        // Reload messages and open the new chat
        await loadMessages();
        closeModal('listingModal');
        go('messages');
        
        setTimeout(() => {
          if(newChat.chatRoomId) {
            openChat(newChat.chatRoomId);
          } else {
            alert('ðŸ’¬ Chat created! You can now message the seller about "' + listing.title + '"');
          }
        }, 300);
        
      }catch(e){
        console.error('Message seller error:', e);
        alert('ðŸ’¬ To message the seller, you need to purchase the item first. When you buy, a chat is automatically created!');
      }
    }
    
    async function submitListing(){
      if(!isAuthed()){
        openAuthModal('login');
        return;
      }
      const title = el('#p_title').value.trim();
      if(title.length<3){
        alert('âš ï¸ Please add a longer title (at least 3 characters).');
        return;
      }
      
      try{
        const formData = new FormData();
        formData.append("title", title);
        formData.append("category", el('#p_category').value);
        formData.append("description", el('#p_desc').value.trim());
        formData.append("price", el('#p_price').value || "0");
        formData.append("visibility", "public");
        
        const fileInput = el('#p_image');
        if(fileInput.files && fileInput.files[0]){
          formData.append("photo", fileInput.files[0]);
        }
        
        const res = await fetch(API_LISTINGS,{
          method:'POST',
          headers:{
            'Authorization':'Bearer '+state.token
          },
          body: formData
        });
        
        if(!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Failed to create listing');
        }
        
        await loadListings();
        await loadMyListings();
        
        el('#p_title').value = '';
        el('#p_category').selectedIndex = 0;
        el('#p_desc').value = '';
        el('#p_price').value = '';
        el('#p_image').value = '';
        el('#imagePreview').innerHTML = '';
        
        alert('âœ… Listing published successfully!\n\n' +
              'ðŸ“¢ Your item is now live on the marketplace\n' +
              'ðŸ’° Buyers can purchase it instantly at your price\n' +
              'ðŸ’¬ You\'ll get an automated message when someone buys');
        go('search');
      }catch(e){
        console.error(e);
        alert('âŒ Could not publish listing: ' + (e.message || 'Please try again.'));
      }
    }
    
    function editListing(id){
      const l = state.myListings.find(x => x.id === id);
      if(!l) return;
      
      state.editingListing = l;
      
      el('#e_title').value = l.title || '';
      el('#e_category').value = l.category || '';
      el('#e_desc').value = l.description || '';
      el('#e_price').value = l.price || 0;
      
      openModal('editListingModal');
    }
    
    async function submitEditListing(){
      if(!state.editingListing) return;
      
      const updates = {
        title: el('#e_title').value.trim(),
        category: el('#e_category').value,
        description: el('#e_desc').value.trim(),
        price: Number(el('#e_price').value||0),
      };
      
      try{
        const res = await fetch(API_LISTING(state.editingListing.id),{
          method:'PUT',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+state.token
          },
          body:JSON.stringify(updates)
        });
        
        if(!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Failed to update listing');
        }
        
        await loadListings();
        await loadMyListings();
        closeModal('editListingModal');
        alert('âœ… Listing updated successfully!');
      }catch(e){
        console.error('Edit listing error:', e);
        alert('âŒ Could not update listing: ' + (e.message || 'Please try again.'));
      }
    }
    
    async function deleteListing(id){
      if(!confirm('Are you sure you want to delete this listing?')) return;
      
      try{
        const res = await fetch(API_LISTING(id),{
          method:'DELETE',
          headers:{'Authorization':'Bearer '+state.token}
        });
        
        if(!res.ok) throw new Error('Failed to delete listing');
        
        await loadListings();
        await loadMyListings();
        alert('Listing deleted.');
      }catch(e){
        console.error(e);
        alert('Could not delete listing. Please try again.');
      }
    }
    
    /* ==================== FAVOURITES ==================== */
    
    async function syncFavourites(){
      if(!isAuthed()) {
        state.favourites = [];
        return;
      }
      
      try{
        const res = await fetch(API_FAVOURITES, {
          headers: {'Authorization': 'Bearer ' + state.token}
        });
        if(!res.ok) throw new Error('Failed to sync favourites');
        state.favourites = await res.json();
      }catch(e){
        console.warn('Failed to sync favourites:', e);
        state.favourites = [];
      }
      renderFavourites();
      renderProfileStats();
    }
    
    function isFav(id){ return state.favourites.includes(id); }
    
    async function toggleFav(id){
      if(!isAuthed()){
        openAuthModal('login');
        return;
      }
      
      const wasFav = isFav(id);
      
      try{
        if(wasFav){
          const res = await fetch(API_FAVOURITE(id), {
            method: 'DELETE',
            headers: {'Authorization': 'Bearer ' + state.token}
          });
          if(!res.ok) throw new Error('Failed to remove favourite');
          state.favourites = state.favourites.filter(fid => fid !== id);
        }else{
          const res = await fetch(API_FAVOURITE(id), {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + state.token}
          });
          if(!res.ok) throw new Error('Failed to add favourite');
          state.favourites.push(id);
        }
        
        renderHome();
        runSearch();
        renderFavourites();
        renderProfileStats();
      }catch(e){
        console.error('Toggle favourite error:', e);
        alert('Could not update favourites. Please try again.');
      }
    }
    
    async function clearFavourites(){
      if(!confirm('Remove all favourites?')) return;
      
      try{
        for(const id of state.favourites){
          await fetch(API_FAVOURITE(id), {
            method: 'DELETE',
            headers: {'Authorization': 'Bearer ' + state.token}
          });
        }
        state.favourites = [];
        renderFavourites();
        renderProfileStats();
      }catch(e){
        console.error('Clear favourites error:', e);
        alert('Could not clear favourites.');
      }
    }
    
    function renderFavourites(){
      const favs = state.listings.filter(l=> state.favourites.includes(l.id));
      el('#favGrid').innerHTML = favs.map(renderListingCard).join('') ||
        '<div class="card" style="text-align:center;padding:40px 20px;"><div style="font-size:48px;margin-bottom:16px;">â­</div><div style="font-size:16px;font-weight:700;margin-bottom:8px;color:var(--neon);">No favourites yet</div><div class="muted">Tap the â˜… star on any listing to save it here.<br/>You can favourite items to easily find them later!</div></div>';
    }
    
    /* ==================== MESSAGES & CHAT ==================== */
    
    async function loadMessages(){
      if(!isAuthed()){
        state.chatRooms = [];
        state.messages = [];
        renderMessages();
        return;
      }
      
      try{
        const res = await fetch(API_CHAT_ROOMS, {
          headers: {'Authorization': 'Bearer ' + state.token}
        });
        if(!res.ok) throw new Error('Failed to load chat rooms');
        
        state.chatRooms = await res.json();
        
        // Map chat rooms to messages format, using correct field names from backend
        state.messages = state.chatRooms.map(room => {
          const otherParty = room.buyerEmail === state.user.email ? room.sellerEmail : room.buyerEmail;
          return {
            id: room.id,
            title: room.listingTitle || 'Chat',
            otherParty: otherParty,
            lastMessage: room.lastMessage || 'No messages yet',
            timestamp: room.lastMessageAt || room.createdAt
          };
        });
        
        console.log('âœ… Loaded messages:', state.messages);
        renderMessages();
      }catch(e){
        console.error('Load messages error:', e);
        state.chatRooms = [];
        state.messages = [];
        renderMessages();
      }
    }
    
    function renderMessages(){
      const list = el('#msgList');
      if(!list) return;
      
      if(!isAuthed()){
        list.innerHTML = '<div class="card" style="text-align:center;padding:40px 20px;"><div style="font-size:48px;margin-bottom:16px;">ðŸ’¬</div><div style="font-size:16px;font-weight:700;margin-bottom:8px;">Log in to see your chats</div><div class="muted">Messages appear here when you buy or sell items</div></div>';
        return;
      }
      
      if(state.messages.length === 0){
        list.innerHTML = '<div class="card" style="text-align:center;padding:40px 20px;"><div style="font-size:48px;margin-bottom:16px;">ðŸ’¬</div><div style="font-size:16px;font-weight:700;margin-bottom:8px;color:var(--neon);">No chats yet</div><div class="muted">When you buy an item, a chat is created automatically with:<br/>âœ“ Automated welcome message<br/>âœ“ Seller contact info<br/>âœ“ Item details</div></div>';
        return;
      }
      
      const sorted = state.messages.slice().sort((a,b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      list.innerHTML = sorted.map(m => {
        const otherName = m.otherParty.split('@')[0] || 'User';
        return `
          <div class="list-item clickable" onclick="openChat('${m.id}')">
            <div class="row" style="gap:12px;flex:1;">
              <div class="avatar">${otherName.slice(0,1).toUpperCase()}</div>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:13px;margin-bottom:2px;">${escapeHtml(m.title)}</div>
                <div class="muted" style="font-size:12px;">with ${escapeHtml(otherName)}</div>
                <div class="muted" style="font-size:11px;margin-top:2px;">${timeAgo(new Date(m.timestamp).getTime())}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function openChat(roomId){
      state.openChatId = roomId;
      
      const room = state.chatRooms.find(r => r.id === roomId);
      if(!room) return;
      
      el('#chatTitle').textContent = room.listingTitle || 'Chat';
      
      try{
        const res = await fetch(API_CHAT_MESSAGES(roomId), {
          headers: {'Authorization': 'Bearer ' + state.token}
        });
        if(!res.ok) throw new Error('Failed to load messages');
        
        const messages = await res.json();
        
        console.log('ðŸ’¬ Chat messages loaded:', messages);
        
        const thread = el('#chatThread');
        thread.innerHTML = messages.map(msg => {
          const isMe = msg.from === state.user.email;
          const isSystem = msg.from === 'system';
          
          if(isSystem){
            return `<div class="bubble" style="background:linear-gradient(135deg,rgba(94,23,235,.2),rgba(193,255,114,.2));border:1px solid var(--neon);max-width:100%;text-align:center;font-size:12px;color:var(--neon);padding:12px;font-weight:600;">
              ðŸŽ‰ ${escapeHtml(msg.message)}
            </div>`;
          }
          
          return `
            <div style="display:flex;${isMe?'justify-content:flex-end':'justify-content:flex-start'}">
              <div class="bubble ${isMe?'me':'them'}">
                ${escapeHtml(msg.message)}
                <div class="muted" style="font-size:10px;margin-top:4px;">${formatMessageTime(msg.createdAt)}</div>
              </div>
            </div>
          `;
        }).join('');
        
        thread.scrollTop = thread.scrollHeight;
        
        openModal('chatModal');
      }catch(e){
        console.error('Open chat error:', e);
        alert('Could not load chat.');
      }
    }
    
    async function sendChat(){
      if(!state.openChatId) return;
      
      const input = el('#chatInput');
      const text = input.value.trim();
      if(!text) return;
      
      try{
        const res = await fetch(API_SEND_MESSAGE(state.openChatId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.token
          },
          body: JSON.stringify({ text })
        });
        
        if(!res.ok) throw new Error('Failed to send message');
        
        input.value = '';
        await openChat(state.openChatId);
      }catch(e){
        console.error('Send message error:', e);
        alert('Could not send message.');
      }
    }
    
    /* ==================== PROFILE ==================== */
    
    function renderProfileStats(){
      el('#stat_mylistings').textContent = state.myListings.length;
      el('#stat_favs').textContent = state.favourites.length;
      
      const since = state.user && state.user.createdAt 
        ? new Date(state.user.createdAt).toLocaleDateString()
        : new Date(state.profile.since).toLocaleDateString();
      el('#pf_since').textContent = since;
      
      if(state.user){
        el('#pf_name').value = state.user.name || '';
        el('#avatar').textContent = (state.user.name || 'U').slice(0,1).toUpperCase();
      }
      
      const saved = localStorage.getItem('cx_profile');
      if(saved){
        try{
          const p = JSON.parse(saved);
          state.profile = p;
          el('#pf_location').value = p.location || '';
          
          // Set university dropdown value if it exists
          const universitySelect = el('#pf_university');
          if(universitySelect && p.university) {
            universitySelect.value = p.university;
          }
        }catch(e){}
      }
    }
    
    function saveProfile(){
      state.profile.name = el('#pf_name').value.trim();
      state.profile.location = el('#pf_location').value.trim();
      state.profile.university = el('#pf_university').value.trim();
      
      localStorage.setItem('cx_profile', JSON.stringify(state.profile));
      alert('Profile saved!');
    }
    
    /* ==================== UTILITIES ==================== */
    
    function escapeHtml(str){
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function timeAgo(timestamp){
      const now = Date.now();
      const diff = now - timestamp;
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if(mins < 1) return 'just now';
      if(mins < 60) return mins + 'm ago';
      if(hrs < 24) return hrs + 'h ago';
      return days + 'd ago';
    }
    
    function formatMessageTime(isoStr){
      const d = new Date(isoStr);
      return d.toLocaleTimeString('en', {hour:'2-digit', minute:'2-digit'});
    }
    
    function observeAll(){
      const observer = new IntersectionObserver(entries => {
        entries.forEach(e => {
          if(e.isIntersecting) e.target.classList.add('in');
        });
      }, { threshold: 0.1 });
      
      els('.reveal').forEach(el => observer.observe(el));
    }
    
    /* ==================== LOCATION SEARCH ==================== */
    
    const madridSegoviaLocations = [
      // Madrid Centro
      "Centro - Madrid", "Sol - Madrid", "Opera - Madrid", "MalasaÃ±a - Madrid", "Chueca - Madrid",
      "LavapiÃ©s - Madrid", "La Latina - Madrid", "Huertas - Madrid", "Barrio de las Letras - Madrid",
      // Madrid Norte
      "ChamartÃ­n - Madrid", "ChamberÃ­ - Madrid", "TetuÃ¡n - Madrid", "Moncloa-Aravaca - Madrid",
      "Fuencarral-El Pardo - Madrid", "Hortaleza - Madrid", "Barajas - Madrid",
      // Madrid Este
      "Salamanca - Madrid", "Retiro - Madrid", "Ciudad Lineal - Madrid", "San Blas-Canillejas - Madrid",
      "VicÃ¡lvaro - Madrid", "Moratalaz - Madrid",
      // Madrid Sur
      "Arganzuela - Madrid", "Carabanchel - Madrid", "Usera - Madrid", "Puente de Vallecas - Madrid",
      "Villa de Vallecas - Madrid", "Villaverde - Madrid",
      // Madrid Oeste
      "Latina - Madrid", "Moncloa - Madrid", "Ciudad Universitaria - Madrid",
      // Segovia
      "Segovia Centro", "Barrio de San Lorenzo - Segovia", "Barrio de San MillÃ¡n - Segovia",
      "Barrio de Santa Eulalia - Segovia", "Barrio del Salvador - Segovia", "Nueva Segovia",
      "Pinar de JalÃ³n - Segovia", "La Albuera - Segovia", "Zamarramala - Segovia",
      // Greater Madrid suburbs
      "AlcalÃ¡ de Henares", "Alcobendas", "AlcorcÃ³n", "Fuenlabrada", "Getafe", "LeganÃ©s",
      "MÃ³stoles", "TorrejÃ³n de Ardoz", "Parla", "Pozuelo de AlarcÃ³n", "Rivas-Vaciamadrid",
      "Majadahonda", "Las Rozas de Madrid", "San SebastiÃ¡n de los Reyes", "Coslada",
      "San Fernando de Henares", "Valdemoro", "Collado Villalba", "Aranjuez", "Boadilla del Monte"
    ].sort();
    
    function initLocationDropdown() {
      const dropdown = el('#locationDropdown');
      dropdown.innerHTML = madridSegoviaLocations
        .map(loc => `<div class="location-option" onclick="selectLocation('${loc}')" style="padding:8px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--line);">${loc}</div>`)
        .join('');
    }
    
    function filterLocations() {
      const input = el('#pf_location');
      const dropdown = el('#locationDropdown');
      const filter = input.value.toLowerCase();
      
      if (!filter) {
        initLocationDropdown();
        return;
      }
      
      const filtered = madridSegoviaLocations.filter(loc => 
        loc.toLowerCase().includes(filter)
      );
      
      if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding:12px;font-size:12px;color:var(--muted);">No locations found</div>';
      } else {
        dropdown.innerHTML = filtered
          .map(loc => `<div class="location-option" onclick="selectLocation('${loc}')" style="padding:8px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--line);">${loc}</div>`)
          .join('');
      }
      
      dropdown.style.display = 'block';
    }
    
    function selectLocation(location) {
      el('#pf_location').value = location;
      el('#locationDropdown').style.display = 'none';
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const locationInput = el('#pf_location');
      const dropdown = el('#locationDropdown');
      if (dropdown && locationInput && !locationInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
    
    // Hover effects for location options
    document.addEventListener('mouseover', function(e) {
      if (e.target.classList.contains('location-option')) {
        e.target.style.background = 'rgba(255,255,255,.04)';
      }
    });
    
    document.addEventListener('mouseout', function(e) {
      if (e.target.classList.contains('location-option')) {
        e.target.style.background = '';
      }
    });
    
    /* ==================== INIT ==================== */
    
    (async function init(){
      restoreAuth();
      await fetchMe();
      updateAuthUI();
      await loadListings();
      if(isAuthed()){
        await syncFavourites();
        await loadMyListings();
        await loadMessages();
      } else {
        renderMessages();
      }
      renderHome();
      observeAll();
      initLocationDropdown();
    })();
  </script>
</body>
</html>
